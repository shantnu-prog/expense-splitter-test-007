---
phase: 12-visual-polish-tech-debt
plan: 02
title: "Tech debt cleanup — type safety, useEffect, error boundary, UPI desktop"
requirements: [DEBT-01, DEBT-02, DEBT-03, DEBT-04]
depends_on: []
estimated_tasks: 4

must_haves:
  - "PeoplePanel and ItemsPanel undo restore calls have zero `as any` casts"
  - "useUndoDelete interfaces use branded types (ItemId, PersonId) instead of plain string"
  - "PeoplePanel assignmentSnapshot uses Record<ItemId, PersonId[]> type"
  - "TipTaxPanel useEffect on subtotal does NOT fire on mount — uses ref to track previous value"
  - "TipTaxPanel eslint-disable comment for react-hooks/exhaustive-deps is removed"
  - "ErrorBoundary class component exists at src/components/ErrorBoundary.tsx"
  - "ErrorBoundary shows 'Something went wrong' fallback with Reload button"
  - "ErrorBoundary wraps AppShell in App.tsx"
  - "Tapping 'Request via UPI' on desktop shows 'Open on mobile to use UPI' message"
  - "UPI button still works normally on mobile (window.location.href for UPI link)"
  - "All existing 144 tests still pass"

key_links:
  - from: "src/hooks/useUndoDelete.ts"
    to: "src/engine/types.ts"
    via: "import ItemId, PersonId branded types for interface definitions"
  - from: "src/App.tsx"
    to: "src/components/ErrorBoundary.tsx"
    via: "ErrorBoundary wraps AppShell"
---

# Plan 12-02: Tech Debt Cleanup

## Goal

Fix all 4 known tech debt items: remove `as any` casts with proper branded types, fix useEffect mount firing, add error boundary, and handle UPI on desktop.

## Context

- DEBT-01: `useUndoDelete.ts` uses `Record<string, string[]>` and `string[]` but restore functions expect branded `Record<ItemId, PersonId[]>` and `PersonId[]`
- DEBT-02: TipTaxPanel useEffect on `[subtotal]` fires on mount, calling setTip unnecessarily
- DEBT-03: App.tsx has no error boundary — React render errors cause white screen
- DEBT-04: PaymentSection `window.location.href = upiUrl` silently fails on desktop

## Tasks

### Task 1: Fix `as any` casts with branded types (DEBT-01)

**Do:**
1. Edit `src/hooks/useUndoDelete.ts`:
   - Update imports to include branded types:
     ```typescript
     import type { Person, Item, ItemId, PersonId } from '../engine/types';
     ```
   - Update `DeletedPerson` interface:
     ```typescript
     export interface DeletedPerson {
       kind: 'person';
       person: Person;
       assignments: Record<ItemId, PersonId[]>;
       assignedItemCount: number;
     }
     ```
   - Update `DeletedItem` interface:
     ```typescript
     export interface DeletedItem {
       kind: 'item';
       item: Item;
       assignedIds: PersonId[];
     }
     ```

2. Edit `src/components/people/PeoplePanel.tsx`:
   - Add import: `import type { ItemId, PersonId } from '../../engine/types';`
   - Update the snapshot type (line ~70):
     Change:
     ```typescript
     const assignmentSnapshot: Record<string, string[]> = {};
     for (const [itemId, personIds] of Object.entries(assignments)) {
     ```
     To:
     ```typescript
     const assignmentSnapshot = {} as Record<ItemId, PersonId[]>;
     for (const [iid, pids] of Object.entries(assignments) as [ItemId, PersonId[]][]) {
       if (pids.includes(personId)) {
         assignmentSnapshot[iid] = [...pids];
       }
     }
     ```
   - Remove the `as any` cast and eslint-disable comment (line 90-91):
     Change:
     ```typescript
     // eslint-disable-next-line @typescript-eslint/no-explicit-any
     restorePerson(snap.person, snap.assignments as any);
     ```
     To:
     ```typescript
     restorePerson(snap.person, snap.assignments);
     ```

3. Edit `src/components/items/ItemsPanel.tsx`:
   - Remove the `as any` cast and eslint-disable comment (line 48-49):
     Change:
     ```typescript
     // eslint-disable-next-line @typescript-eslint/no-explicit-any
     restoreItem(snap.item, snap.assignedIds as any);
     ```
     To:
     ```typescript
     restoreItem(snap.item, snap.assignedIds);
     ```

**Verify:**
- `npx tsc --noEmit` passes (zero `as any` in these files)
- `npx vitest run` — all tests pass (behavior unchanged)

### Task 2: Fix useEffect mount firing in TipTaxPanel (DEBT-02)

**Do:**
1. Edit `src/components/tip-tax/TipTaxPanel.tsx`:
   - Add `useRef` to imports: `import { useState, useEffect, useRef } from 'react';`
   - Add ref after the subtotal declaration:
     ```typescript
     const prevSubtotalRef = useRef(subtotal);
     ```
   - Replace the useEffect (lines 109-118):
     ```typescript
     useEffect(() => {
       // Skip initial mount — only recalculate when subtotal actually changes
       if (prevSubtotalRef.current === subtotal) return;
       prevSubtotalRef.current = subtotal;

       const tipCents = computeTipCents(tipPreset, customTipPct);
       setTip(tipCents, tipConfig.method, false);
     }, [subtotal]);
     ```
   - Remove the `// eslint-disable-next-line react-hooks/exhaustive-deps` comment

**Verify:**
- `npx tsc --noEmit` passes
- `npx vitest run` — all tests pass

### Task 3: Add error boundary (DEBT-03)

**Do:**
1. Create `src/components/ErrorBoundary.tsx`:
   ```tsx
   import { Component, type ReactNode } from 'react';

   interface Props {
     children: ReactNode;
   }

   interface State {
     hasError: boolean;
   }

   export class ErrorBoundary extends Component<Props, State> {
     state: State = { hasError: false };

     static getDerivedStateFromError(): State {
       return { hasError: true };
     }

     render() {
       if (this.state.hasError) {
         return (
           <div className="flex flex-col items-center justify-center h-screen bg-gray-950 text-center px-6">
             <h1 className="text-xl font-bold text-white mb-2">Something went wrong</h1>
             <p className="text-gray-400 mb-6">The app encountered an unexpected error.</p>
             <button
               onClick={() => window.location.reload()}
               className="px-6 min-h-12 bg-blue-600 text-white rounded-lg font-medium active:bg-blue-700"
             >
               Reload App
             </button>
           </div>
         );
       }
       return this.props.children;
     }
   }
   ```

2. Edit `src/App.tsx`:
   - Add import: `import { ErrorBoundary } from './components/ErrorBoundary';`
   - Wrap AppShell with ErrorBoundary:
     ```tsx
     function App() {
       return (
         <>
           <ErrorBoundary>
             <AppShell />
           </ErrorBoundary>
           <ReloadPrompt />
         </>
       );
     }
     ```
   - Note: ReloadPrompt stays OUTSIDE ErrorBoundary so PWA updates still work even if the main app crashes

**Verify:**
- `npx tsc --noEmit` passes
- `npx vitest run` — all tests pass

### Task 4: Desktop UPI message (DEBT-04)

**Do:**
1. Edit `src/components/summary/PaymentSection.tsx`:
   - Add `import { useState } from 'react';`
   - Add state for desktop message inside the component:
     ```typescript
     const [desktopUpiMsg, setDesktopUpiMsg] = useState(false);
     ```
   - Replace the `handleUpiClick` function:
     ```typescript
     function handleUpiClick(upiUrl: string) {
       const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
       if (!isMobile) {
         setDesktopUpiMsg(true);
         setTimeout(() => setDesktopUpiMsg(false), 3000);
         return;
       }
       window.location.href = upiUrl;
     }
     ```
   - Add the desktop message below the hint text (after line ~116, before the closing `</div>` of the debtors list):
     ```tsx
     {desktopUpiMsg && (
       <p className="text-amber-400/80 text-xs text-center mt-2">
         Open on your mobile device to use UPI payments
       </p>
     )}
     ```

**Verify:**
- `npx tsc --noEmit` passes
- `npx vitest run` — all 144 tests pass
- `npm run build` succeeds

## Acceptance

After this plan:
- Zero `as any` casts in PeoplePanel and ItemsPanel undo restore
- TipTaxPanel useEffect only fires when subtotal CHANGES, not on mount
- ErrorBoundary catches render crashes and shows recovery UI
- UPI button on desktop shows "Open on mobile" message; still works on mobile
- All 144 tests pass, TypeScript clean, build succeeds
