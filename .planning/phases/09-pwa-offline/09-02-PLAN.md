---
phase: 09-pwa-offline
plan: 02
title: "ReloadPrompt component and App integration"
requirements: [PWA-03]
depends_on: [09-01]
estimated_tasks: 2

must_haves:
  - "ReloadPrompt component exists at src/components/ReloadPrompt.tsx using useRegisterSW hook from virtual:pwa-register/react"
  - "ReloadPrompt shows 'App ready to work offline' notification on first install"
  - "ReloadPrompt shows 'New version available' with an Update button when a new service worker is detected"
  - "Tapping Update calls updateServiceWorker(true) to activate the new SW and reload"
  - "ReloadPrompt has a Close/dismiss button that hides the notification"
  - "ReloadPrompt is positioned as a fixed toast above the TabBar (bottom-20) so it doesn't overlap navigation"
  - "ReloadPrompt is mounted in App.tsx alongside AppShell"
  - "ReloadPrompt styling matches the dark theme (gray-800 background, white text)"
  - "All existing 144 tests still pass — ReloadPrompt does not interfere with test environment (useRegisterSW is a no-op when no SW is registered)"

key_links:
  - from: "src/components/ReloadPrompt.tsx"
    to: "virtual:pwa-register/react"
    via: "import { useRegisterSW } from 'virtual:pwa-register/react'"
  - from: "src/App.tsx"
    to: "src/components/ReloadPrompt.tsx"
    via: "import and render <ReloadPrompt /> alongside <AppShell />"
---

# Plan 09-02: ReloadPrompt Component and App Integration

## Goal

Create the user-facing PWA update prompt so users see "offline ready" confirmation on first visit and "new version available" with an Update button when the app is updated — without auto-reloading and losing in-progress bill data.

## Context

- Plan 09-01 installed vite-plugin-pwa with `registerType: 'prompt'`
- `registerType: 'prompt'` means the service worker waits for user action before activating
- The `useRegisterSW` hook from `virtual:pwa-register/react` provides `offlineReady`, `needRefresh`, and `updateServiceWorker`
- Current `App.tsx` renders only `<AppShell />`
- The app uses dark theme (gray-950 background) with Tailwind CSS
- TabBar is fixed at the bottom — ReloadPrompt must not overlap it

## Tasks

### Task 1: Create ReloadPrompt component

**Do:**
1. Create `src/components/ReloadPrompt.tsx`:

```tsx
import { useRegisterSW } from 'virtual:pwa-register/react'

export function ReloadPrompt() {
  const {
    offlineReady: [offlineReady, setOfflineReady],
    needRefresh: [needRefresh, setNeedRefresh],
    updateServiceWorker,
  } = useRegisterSW()

  const close = () => {
    setOfflineReady(false)
    setNeedRefresh(false)
  }

  if (!offlineReady && !needRefresh) return null

  return (
    <div
      role="alert"
      className="fixed bottom-20 left-4 right-4 z-50 flex items-center justify-between rounded-lg bg-gray-800 px-4 py-3 shadow-lg"
    >
      <p className="text-sm text-white">
        {offlineReady ? 'App ready to work offline.' : 'New version available.'}
      </p>
      <div className="flex shrink-0 gap-2">
        {needRefresh && (
          <button
            onClick={() => updateServiceWorker(true)}
            className="rounded bg-blue-600 px-3 py-1.5 text-sm font-medium text-white"
          >
            Update
          </button>
        )}
        <button
          onClick={close}
          className="rounded border border-gray-600 px-3 py-1.5 text-sm text-gray-300"
        >
          Close
        </button>
      </div>
    </div>
  )
}
```

Key design decisions:
- `bottom-20` positions above the TabBar (which is ~48px + safe area)
- `left-4 right-4` makes it a full-width toast on mobile
- `bg-gray-800` matches the dark theme (not white which would clash)
- `z-50` ensures it floats above all content
- Named export (not default) to match project conventions
- `role="alert"` for accessibility

**Verify:**
- File exists and TypeScript compiles clean
- Component returns null when neither offlineReady nor needRefresh is true
- Both message variants are present

### Task 2: Mount ReloadPrompt in App.tsx

**Do:**
1. Edit `src/App.tsx`:

```tsx
import { AppShell } from './components/layout/AppShell';
import { ReloadPrompt } from './components/ReloadPrompt';

function App() {
  return (
    <>
      <AppShell />
      <ReloadPrompt />
    </>
  );
}

export default App;
```

**Verify:**
- `npx tsc --noEmit` passes
- `npx vitest run` — all 144 tests pass (useRegisterSW returns default state in non-SW environment)
- `npm run build` succeeds
- In preview mode (`npm run preview`), the "App ready to work offline" toast appears on first load

## Acceptance

After this plan:
- First-time visitor sees "App ready to work offline" toast after SW installs
- Returning visitor with a new build sees "New version available" toast with Update button
- Tapping Update reloads the app with the new version
- Tapping Close dismisses the toast
- Toast is visible above the TabBar and matches dark theme
- All 144 tests pass, build succeeds
- Service worker does NOT register during `vite dev` (only in build + preview)
