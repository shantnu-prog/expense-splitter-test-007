---
phase: 08-upi-payments
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/utils/buildUpiLink.ts
  - src/utils/buildUpiLink.test.ts
  - src/components/summary/PaymentSection.tsx
  - src/components/summary/SummaryPanel.tsx
autonomous: true
requirements:
  - PAY-03
  - PAY-04
  - PAY-05

must_haves:
  truths:
    - "buildUpiLink produces a correctly encoded upi://pay URL with pa, pn, am, cu=INR, and tn parameters"
    - "User can select who paid the bill from a dropdown of current people"
    - "Each non-payer person with a UPI VPA shows a 'Request via UPI' button"
    - "Tapping 'Request via UPI' opens the upi:// deep link (or copies to clipboard as fallback)"
    - "Persons without a UPI VPA show their owed amount without a broken UPI button"
    - "Payer is excluded from the payment request list"
    - "Zero-amount persons are excluded from payment requests"
  artifacts:
    - path: "src/utils/buildUpiLink.ts"
      provides: "Pure function to construct upi://pay URL from payee VPA, name, amount, and note"
      exports: ["buildUpiLink"]
    - path: "src/utils/buildUpiLink.test.ts"
      provides: "Unit tests for buildUpiLink — URL encoding, amount formatting, edge cases"
      exports: []
    - path: "src/components/summary/PaymentSection.tsx"
      provides: "Payer selector dropdown, per-person UPI request buttons, fallback for missing VPA"
      exports: ["PaymentSection"]
    - path: "src/components/summary/SummaryPanel.tsx"
      provides: "Mounts PaymentSection below person cards when result is ok"
      exports: ["SummaryPanel"]
  key_links:
    - from: "src/components/summary/PaymentSection.tsx"
      to: "src/utils/buildUpiLink.ts"
      via: "import buildUpiLink to generate UPI deep link URLs"
      pattern: "buildUpiLink"
    - from: "src/components/summary/PaymentSection.tsx"
      to: "src/engine/types.ts"
      via: "import Person, PersonId, PersonResult types"
      pattern: "Person|PersonId|PersonResult"
    - from: "src/components/summary/SummaryPanel.tsx"
      to: "src/components/summary/PaymentSection.tsx"
      via: "render PaymentSection with people and results"
      pattern: "PaymentSection"
---

<objective>
Add payer selection and UPI deep link payment requests to the Split tab.

Purpose: After computing the split, the person who paid the bill selects themselves as payer. Each other person who owes money sees a "Request via UPI" button that opens PhonePe/GPay/Paytm with pre-filled payee VPA, amount, and transaction note. Persons without a UPI VPA see their amount only (no broken link).

Output: buildUpiLink utility generates correct `upi://pay?...` URLs. PaymentSection component renders payer selector and per-person UPI buttons. SummaryPanel mounts PaymentSection.
</objective>

<execution_context>
@/Users/shantnupatil/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantnupatil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-upi-payments/08-RESEARCH.md
@.planning/phases/08-upi-payments/08-01-PLAN.md

@src/engine/types.ts
@src/utils/currency.ts
@src/components/summary/SummaryPanel.tsx
@src/components/summary/PersonCard.tsx
@src/store/billStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create buildUpiLink utility and tests</name>
  <files>
    src/utils/buildUpiLink.ts
    src/utils/buildUpiLink.test.ts
  </files>
  <action>
**Create `src/utils/buildUpiLink.ts`:**

A pure function that constructs a UPI deep link URL per NPCI specification.

```typescript
/**
 * src/utils/buildUpiLink.ts
 *
 * Constructs a UPI deep link URL for payment requests.
 * Format: upi://pay?pa=<VPA>&pn=<NAME>&am=<AMOUNT>&cu=INR&tn=<NOTE>
 */

interface UpiLinkParams {
  /** Payee VPA (the person receiving money), e.g. "alice@ybl" */
  payeeVpa: string;
  /** Payee display name */
  payeeName: string;
  /** Amount in integer cents */
  amountCents: number;
  /** Transaction note (optional) */
  note?: string;
}

/**
 * Build a UPI deep link URL.
 *
 * - Amount is converted from cents to rupees (2 decimal places)
 * - All parameters are URI-encoded
 * - Returns null if payeeVpa is empty or amountCents <= 0
 */
export function buildUpiLink(params: UpiLinkParams): string | null {
  const { payeeVpa, payeeName, amountCents, note } = params;

  if (!payeeVpa.trim() || amountCents <= 0) return null;

  const amount = (amountCents / 100).toFixed(2);

  const searchParams = new URLSearchParams({
    pa: payeeVpa.trim(),
    pn: payeeName.trim(),
    am: amount,
    cu: 'INR',
  });

  if (note?.trim()) {
    searchParams.set('tn', note.trim());
  }

  return `upi://pay?${searchParams.toString()}`;
}
```

Key design points:
- Returns `null` for invalid inputs (empty VPA, zero/negative amount) — callers check for null
- Uses `URLSearchParams` for proper encoding of special characters in names/notes
- Amount converts cents to rupees with 2 decimal places
- Currency is hardcoded to INR per the UPI spec

**Create `src/utils/buildUpiLink.test.ts`:**

```typescript
import { describe, it, expect } from 'vitest';
import { buildUpiLink } from './buildUpiLink';

describe('buildUpiLink', () => {
  it('builds a valid UPI link with all parameters', () => {
    const url = buildUpiLink({
      payeeVpa: 'alice@ybl',
      payeeName: 'Alice',
      amountCents: 2350,
      note: 'Bill split via SplitCheck',
    });

    expect(url).toBe(
      'upi://pay?pa=alice%40ybl&pn=Alice&am=23.50&cu=INR&tn=Bill+split+via+SplitCheck'
    );
  });

  it('builds a link without a note', () => {
    const url = buildUpiLink({
      payeeVpa: 'bob@paytm',
      payeeName: 'Bob',
      amountCents: 1000,
    });

    expect(url).toContain('pa=bob%40paytm');
    expect(url).toContain('am=10.00');
    expect(url).toContain('cu=INR');
    expect(url).not.toContain('tn=');
  });

  it('returns null for empty VPA', () => {
    expect(buildUpiLink({ payeeVpa: '', payeeName: 'X', amountCents: 100 })).toBeNull();
    expect(buildUpiLink({ payeeVpa: '  ', payeeName: 'X', amountCents: 100 })).toBeNull();
  });

  it('returns null for zero or negative amount', () => {
    expect(buildUpiLink({ payeeVpa: 'a@b', payeeName: 'A', amountCents: 0 })).toBeNull();
    expect(buildUpiLink({ payeeVpa: 'a@b', payeeName: 'A', amountCents: -100 })).toBeNull();
  });

  it('formats small amounts correctly', () => {
    const url = buildUpiLink({ payeeVpa: 'a@b', payeeName: 'A', amountCents: 5 });
    expect(url).toContain('am=0.05');
  });

  it('encodes special characters in name', () => {
    const url = buildUpiLink({ payeeVpa: 'a@b', payeeName: 'José & María', amountCents: 100 });
    expect(url).toContain('pn=Jos');
    expect(url).not.toBeNull();
  });
});
```
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run src/utils/buildUpiLink.test.ts` — all tests pass.
  </verify>
  <done>
buildUpiLink utility creates valid UPI deep link URLs. Returns null for invalid inputs. All edge cases tested.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PaymentSection component</name>
  <files>
    src/components/summary/PaymentSection.tsx
  </files>
  <action>
**Create `src/components/summary/PaymentSection.tsx`:**

This component renders below the person cards in the Split tab. It has two sections:
1. **Payer selector** — dropdown to select who paid the bill
2. **Payment request list** — each non-payer person who owes money, with UPI button or amount-only fallback

```tsx
/**
 * src/components/summary/PaymentSection.tsx
 *
 * Payer selector and per-person UPI payment request buttons.
 * Shown in the Split tab after person cards when the bill is computed.
 */

import { useState } from 'react';
import { buildUpiLink } from '../../utils/buildUpiLink';
import { centsToDollars } from '../../utils/currency';
import { cents } from '../../engine/types';
import type { Person, PersonId, PersonResult } from '../../engine/types';

interface PaymentSectionProps {
  people: Person[];
  results: PersonResult[];
}

export function PaymentSection({ people, results }: PaymentSectionProps) {
  const [payerId, setPayerId] = useState<PersonId | ''>('');

  // Find the payer's Person object (for VPA and name)
  const payer = people.find((p) => p.id === payerId) ?? null;

  // Non-payer people who owe money (amount > 0)
  const debtors = results
    .filter((r) => r.personId !== payerId && r.roundedTotalCents > 0)
    .map((r) => ({
      person: people.find((p) => p.id === r.personId)!,
      result: r,
    }))
    .filter((d) => d.person != null);

  function handleUpiClick(upiUrl: string) {
    // Try to open the UPI link directly (works on mobile)
    window.location.href = upiUrl;
  }

  return (
    <div className="px-4 pt-4">
      {/* Section header */}
      <h3 className="text-gray-400 text-sm font-medium mb-3">Request Payments</h3>

      {/* Payer selector */}
      <label className="block mb-4">
        <span className="text-gray-500 text-xs mb-1 block">Who paid the bill?</span>
        <select
          value={payerId}
          onChange={(e) => setPayerId(e.target.value as PersonId)}
          className="w-full min-h-12 px-4 bg-gray-800 text-gray-100 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none text-base appearance-none"
        >
          <option value="">Select payer...</option>
          {people.map((p) => (
            <option key={p.id} value={p.id}>{p.name}</option>
          ))}
        </select>
      </label>

      {/* Payment request list — only shown when a payer is selected */}
      {payer && (
        <div className="flex flex-col gap-2">
          {debtors.length === 0 && (
            <p className="text-gray-500 text-sm text-center py-4">No payments to request</p>
          )}

          {debtors.map(({ person, result }) => {
            const amount = centsToDollars(cents(result.roundedTotalCents));
            const upiUrl = payer.upiVpa
              ? buildUpiLink({
                  payeeVpa: payer.upiVpa,
                  payeeName: payer.name,
                  amountCents: result.roundedTotalCents,
                  note: 'Bill split via SplitCheck',
                })
              : null;

            return (
              <div
                key={person.id}
                className="flex items-center justify-between bg-gray-900 border border-gray-800 rounded-xl px-4 py-3"
              >
                <div className="flex-1 min-w-0">
                  <span className="text-gray-100 text-sm font-medium">{person.name}</span>
                  <span className="text-gray-400 text-sm ml-2">${amount}</span>
                </div>

                {upiUrl ? (
                  <button
                    onClick={() => handleUpiClick(upiUrl)}
                    className="ml-3 px-4 min-h-10 bg-green-600 text-white text-sm font-medium rounded-lg active:bg-green-700 shrink-0"
                  >
                    Request via UPI
                  </button>
                ) : (
                  <span className="ml-3 text-gray-500 text-xs shrink-0">No UPI ID</span>
                )}
              </div>
            );
          })}

          {/* Hint when payer has no VPA */}
          {!payer.upiVpa && debtors.length > 0 && (
            <p className="text-amber-400/80 text-xs text-center mt-1">
              Add your UPI ID in the People tab to enable payment requests
            </p>
          )}
        </div>
      )}
    </div>
  );
}
```

Key design decisions:
- **Payer state is local** (`useState`) — not in bill store or history (display preference only, per research decision #6)
- **UPI link uses payer's VPA** as `pa` (payee) — the person tapping the link pays the payer
- **"No UPI ID" fallback** — shows amount text without a broken button when payer has no VPA
- **Hint message** — when payer has no VPA, guide them to add it in the People tab
- **Green button** — "Request via UPI" uses green color to distinguish from the blue action buttons
- **`window.location.href`** — standard way to trigger UPI deep links on mobile; on desktop it does nothing harmful
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>
PaymentSection component renders payer selector, per-person UPI request buttons, and fallback for missing VPA. Payer excluded from requests. Zero-amount persons excluded.
  </done>
</task>

<task type="auto">
  <name>Task 3: Mount PaymentSection in SummaryPanel</name>
  <files>
    src/components/summary/SummaryPanel.tsx
  </files>
  <action>
**1. Add import** at the top of SummaryPanel.tsx:
```typescript
import { PaymentSection } from './PaymentSection';
```

**2. Mount PaymentSection** after the person cards and rounding footer, before the "Copy summary" button. Insert inside the `flex-1 px-4 pt-4` div, after the RoundingFooter:

```tsx
{/* Scrollable person cards area */}
<div className="flex-1 px-4 pt-4">
  {successResult.results.map((personResult) => {
    const person = people.find((p) => p.id === personResult.personId);
    if (!person) return null;

    return (
      <PersonCard
        key={personResult.personId}
        person={person}
        result={personResult}
        onCopy={handlePersonCopy}
      />
    );
  })}

  {/* Rounding surplus footer */}
  {successResult.totalSurplusCents > 0 && (
    <RoundingFooter surplusCents={successResult.totalSurplusCents} />
  )}
</div>

{/* UPI Payment section */}
<PaymentSection people={people} results={successResult.results} />

{/* Copy all button — bottom of panel */}
<div className="px-4 pt-4 pb-4 border-t border-gray-800 mt-4">
```

The PaymentSection sits between the person cards area and the action buttons. It receives the `people` array and `results` array from the already-computed `successResult`.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run` — all tests pass.
Run `npm run build` — production build succeeds.
  </verify>
  <done>
PaymentSection mounted in SummaryPanel between person cards and action buttons. Receives people and results. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` — all tests pass (no regressions), buildUpiLink tests pass
3. `npm run build` — production build succeeds
4. Browser: go to Split tab without selecting a payer → "Select payer..." dropdown visible, no payment rows
5. Browser: select a payer who has a UPI VPA → each other person shows "Request via UPI" button with correct amount
6. Browser: tap "Request via UPI" → UPI deep link triggered (opens UPI app on mobile)
7. Browser: select a payer who has NO UPI VPA → each person shows amount with "No UPI ID" text, hint message appears
8. Browser: person with zero amount → excluded from payment request list
9. Browser: only one person in bill → select them as payer → "No payments to request" message
</verification>

<success_criteria>
- buildUpiLink creates valid upi://pay URLs with correct parameters
- User can select who paid from a dropdown
- Non-payer persons with payer UPI VPA see "Request via UPI" button
- UPI link has correct payee VPA (payer's), amount (in INR), and note
- Persons without payer UPI VPA see fallback (amount only, no broken link)
- Zero-amount and payer persons excluded from request list
</success_criteria>

<output>
After completion, create `.planning/phases/08-upi-payments/08-02-SUMMARY.md`
</output>
