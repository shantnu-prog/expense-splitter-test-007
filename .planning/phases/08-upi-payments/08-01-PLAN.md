---
phase: 08-upi-payments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/types.ts
  - src/storage/deserializeBillConfig.ts
  - src/store/billStore.ts
  - src/components/people/PeoplePanel.tsx
  - src/components/people/PersonRow.tsx
autonomous: true
requirements:
  - PAY-01
  - PAY-02

must_haves:
  truths:
    - "Person interface has optional mobile and upiVpa string fields"
    - "User can enter mobile number and UPI VPA when adding a person"
    - "Contact details persist across page refresh via billStore persist middleware"
    - "Old saved splits without contact fields load without crashing — fields default to undefined"
    - "Contact details are visible on each person row in the People panel"
  artifacts:
    - path: "src/engine/types.ts"
      provides: "Person interface extended with optional mobile and upiVpa fields"
      exports: ["Person"]
    - path: "src/storage/deserializeBillConfig.ts"
      provides: "Deserialization handles optional mobile and upiVpa fields with undefined defaults"
      exports: ["deserializeBillConfig"]
    - path: "src/store/billStore.ts"
      provides: "addPerson accepts optional contact details; persist version bumped to 2 with migration"
      exports: ["useBillStore", "BillState"]
    - path: "src/components/people/PeoplePanel.tsx"
      provides: "Mobile and UPI VPA input fields in the add-person form"
      exports: ["PeoplePanel"]
    - path: "src/components/people/PersonRow.tsx"
      provides: "Displays contact details (mobile, UPI VPA) below person name"
      exports: ["PersonRow"]
  key_links:
    - from: "src/storage/deserializeBillConfig.ts"
      to: "src/engine/types.ts"
      via: "import Person type with new optional fields"
      pattern: "mobile.*upiVpa"
    - from: "src/store/billStore.ts"
      to: "src/engine/types.ts"
      via: "addPerson uses Person type with contact fields"
      pattern: "mobile|upiVpa"
    - from: "src/components/people/PeoplePanel.tsx"
      to: "src/store/billStore.ts"
      via: "calls addPerson with contact details"
      pattern: "addPerson.*mobile|upiVpa"
---

<objective>
Extend the Person data model with contact details (mobile + UPI VPA), update the input UI to collect them, and ensure backwards compatibility with existing saved splits.

Purpose: UPI payment links need the payee's VPA address. This plan adds optional contact fields to the Person interface, updates the add-person flow to collect mobile number and UPI VPA, ensures old saved data loads without crashing via schema migration, and displays contact info on person rows.

Output: Person type has mobile/upiVpa fields. PeoplePanel collects them. PersonRow displays them. Old splits migrate cleanly.
</objective>

<execution_context>
@/Users/shantnupatil/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantnupatil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-upi-payments/08-RESEARCH.md

@src/engine/types.ts
@src/storage/deserializeBillConfig.ts
@src/store/billStore.ts
@src/components/people/PeoplePanel.tsx
@src/components/people/PersonRow.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Person type and update deserialization</name>
  <files>
    src/engine/types.ts
    src/storage/deserializeBillConfig.ts
  </files>
  <action>
**types.ts changes:**

Add optional contact fields to the `Person` interface:

```typescript
/** A person participating in the bill split. */
export interface Person {
  id: PersonId;
  name: string;
  /** Mobile number (optional, for contact/UPI). */
  mobile?: string;
  /** UPI Virtual Payment Address, e.g. "alice@ybl" (optional, for UPI payment links). */
  upiVpa?: string;
}
```

No other changes to types.ts. The engine (`computeSplit`) does not use these fields — they are metadata only.

**deserializeBillConfig.ts changes:**

Update the intermediate cast type to include the new optional fields:

```typescript
people: Array<{ id: string; name: string; mobile?: string; upiVpa?: string }>;
```

Update the people mapping to pass through the optional fields:

```typescript
people: r.people.map((p) => ({
  id: personId(p.id),
  name: p.name,
  ...(p.mobile !== undefined && { mobile: p.mobile }),
  ...(p.upiVpa !== undefined && { upiVpa: p.upiVpa }),
})),
```

This handles old data (no mobile/upiVpa fields) by simply not including them — they stay `undefined` on the resulting Person object, matching the `?:` optional type.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run src/storage/deserializeBillConfig.test.ts` — all existing round-trip tests pass (old data format still works).
  </verify>
  <done>
Person interface has optional mobile and upiVpa fields. Deserialization handles both present and absent fields correctly. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update billStore addPerson action and schema migration</name>
  <files>
    src/store/billStore.ts
  </files>
  <action>
**1. Update addPerson signature** to accept optional contact details:

Change the interface:
```typescript
addPerson: (name: string, contact?: { mobile?: string; upiVpa?: string }) => void;
```

Change the implementation:
```typescript
addPerson(name: string, contact?: { mobile?: string; upiVpa?: string }) {
  set((state) => {
    const id = personId(crypto.randomUUID());
    const person: Person = { id, name };
    if (contact?.mobile) person.mobile = contact.mobile;
    if (contact?.upiVpa) person.upiVpa = contact.upiVpa;
    state.config.people.push(person);
  });
},
```

**2. Update updatePerson** to support contact field updates:

Change the type constraint to allow mobile and upiVpa:
```typescript
updatePerson(id: PersonId, updates: Partial<Pick<Person, 'name' | 'mobile' | 'upiVpa'>>) {
```

The existing `Object.assign(person, updates)` implementation handles the new fields automatically.

**3. Bump persist version** from 1 to 2 and add migration:

```typescript
version: 2,
migrate(persisted: unknown, fromVersion: number) {
  if (fromVersion === 1) {
    // v1 → v2: Person gains optional mobile and upiVpa fields
    // No actual data transform needed — fields are optional (undefined by default)
    // deserializeBillConfig handles missing fields gracefully
    return persisted as Pick<BillState, 'config'>;
  }
  return persisted as Pick<BillState, 'config'>;
},
```

The migration is a no-op because the new fields are optional (`?:`). Old configs without mobile/upiVpa are valid — `undefined` is the correct default.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run src/store/billStore.test.ts` — all 24 existing tests pass.
  </verify>
  <done>
addPerson accepts optional contact details. updatePerson supports mobile and upiVpa updates. Persist version bumped to 2 with migration stub. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update PeoplePanel with contact input fields</name>
  <files>
    src/components/people/PeoplePanel.tsx
  </files>
  <action>
Add mobile and UPI VPA input fields to the add-person form in PeoplePanel.

**1. Add state for contact fields:**
```typescript
const [mobile, setMobile] = useState('');
const [upiVpa, setUpiVpa] = useState('');
const [showContact, setShowContact] = useState(false);
```

**2. Update handleAdd** to pass contact details:
```typescript
function handleAdd() {
  const trimmed = name.trim();
  if (trimmed === '') { setError('Name required'); return; }
  if (people.some((p) => p.name.toLowerCase() === trimmed.toLowerCase())) {
    setError('Name already exists');
    return;
  }

  const contact: { mobile?: string; upiVpa?: string } = {};
  if (mobile.trim()) contact.mobile = mobile.trim();
  if (upiVpa.trim()) contact.upiVpa = upiVpa.trim();

  addPerson(trimmed, Object.keys(contact).length > 0 ? contact : undefined);
  setName('');
  setMobile('');
  setUpiVpa('');
  setError('');
  setShowContact(false);
}
```

**3. Add contact fields toggle and inputs** below the name input row, inside the form div:

```tsx
{/* Contact details toggle */}
<button
  type="button"
  onClick={() => setShowContact(!showContact)}
  className="text-blue-400 text-sm font-medium mt-2 min-h-8"
>
  {showContact ? '− Hide contact details' : '+ Add contact details'}
</button>

{/* Contact fields (collapsible) */}
{showContact && (
  <div className="flex flex-col gap-2 mt-2">
    <input
      type="tel"
      value={mobile}
      onChange={(e) => setMobile(e.target.value)}
      placeholder="Mobile number"
      className="min-h-12 px-4 bg-gray-800 text-gray-100 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none text-base"
      inputMode="tel"
    />
    <input
      type="text"
      value={upiVpa}
      onChange={(e) => setUpiVpa(e.target.value)}
      placeholder="UPI ID (e.g., name@ybl)"
      className="min-h-12 px-4 bg-gray-800 text-gray-100 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none text-base"
      inputMode="text"
      autoCapitalize="none"
    />
  </div>
)}
```

Place the toggle and contact fields AFTER the name+Add button row, still inside the `p-4 border-b border-gray-800` form container div.

The `inputMode="tel"` on mobile input shows the numeric keypad on mobile. The `autoCapitalize="none"` on UPI VPA prevents capitalization of the VPA.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>
PeoplePanel has collapsible contact fields (mobile + UPI VPA) below the name input. Fields are optional and clear on add. Contact details passed to addPerson.
  </done>
</task>

<task type="auto">
  <name>Task 4: Update PersonRow to display contact details</name>
  <files>
    src/components/people/PersonRow.tsx
  </files>
  <action>
Update PersonRow to show contact details (mobile + UPI VPA) below the person's name.

**1. Extend props** to include optional contact fields:
```typescript
interface PersonRowProps {
  name: string;
  mobile?: string;
  upiVpa?: string;
  onRemove: () => void;
}
```

**2. Update the component** to display contact info when present:
```tsx
export function PersonRow({ name, mobile, upiVpa, onRemove }: PersonRowProps) {
  const hasContact = mobile || upiVpa;

  return (
    <div className="flex items-center justify-between px-4 py-3 border-b border-gray-800">
      <div className="flex-1 min-w-0">
        <span className="text-gray-100">{name}</span>
        {hasContact && (
          <div className="flex flex-wrap gap-x-3 mt-0.5">
            {mobile && (
              <span className="text-gray-500 text-xs">{mobile}</span>
            )}
            {upiVpa && (
              <span className="text-gray-500 text-xs">{upiVpa}</span>
            )}
          </div>
        )}
      </div>
      <button
        onClick={onRemove}
        aria-label={`Remove ${name}`}
        className="min-h-11 min-w-11 flex items-center justify-center text-gray-400 active:text-red-400 shrink-0"
      >
        ×
      </button>
    </div>
  );
}
```

**3. Update PeoplePanel** where PersonRow is rendered to pass the new props:
```tsx
<PersonRow
  key={person.id}
  name={person.name}
  mobile={person.mobile}
  upiVpa={person.upiVpa}
  onRemove={() => handleRemove(person.id)}
/>
```
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run` — all tests pass.
Run `npm run build` — production build succeeds.
  </verify>
  <done>
PersonRow displays mobile and UPI VPA below the person name when present. PeoplePanel passes contact props. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` — all tests pass (no regressions)
3. `npm run build` — production build succeeds
4. Browser: add a person with name only → no contact details shown on row
5. Browser: add a person with name + mobile + UPI VPA → contact details visible below name
6. Browser: refresh page → contact details persist (visible after reload)
7. Browser: load an old saved split (from before Phase 8) → loads without crash, contact fields absent
</verification>

<success_criteria>
- Person interface has optional mobile and upiVpa fields
- PeoplePanel has collapsible contact input fields
- PersonRow shows contact details when present
- Contact details persist across page refresh
- Old saved splits load without crashing
- Schema version bumped to 2 with migration
</success_criteria>

<output>
After completion, create `.planning/phases/08-upi-payments/08-01-SUMMARY.md`
</output>
