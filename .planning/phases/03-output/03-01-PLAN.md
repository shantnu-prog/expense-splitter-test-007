---
phase: 03-output
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/layout/TabBar.tsx
  - src/components/layout/AppShell.tsx
  - src/components/tip-tax/TipTaxPanel.tsx
  - src/components/tip-tax/TipSegmentedControl.tsx
  - src/components/tip-tax/TaxInput.tsx
  - src/components/tip-tax/SplitMethodToggle.tsx
  - src/components/tip-tax/TipTaxPanel.test.tsx
autonomous: true
requirements:
  - TPTX-01
  - TPTX-03

must_haves:
  truths:
    - "User can select tip percentage from 15%, 18%, or 20% presets and the store's tip amountCents updates accordingly"
    - "User can select 'Custom' and type a custom tip percentage, and the store updates with the computed cents"
    - "User can enter tax as a dollar amount and the store's tax amountCents updates"
    - "User can switch tax to percentage mode and enter a percentage, and the store updates with the computed cents"
    - "User can independently choose equal or proportional split method for tip and for tax"
    - "A 4th 'Split' tab appears in the bottom tab bar and shows the Tip/Tax controls"
  artifacts:
    - path: "src/components/tip-tax/TipTaxPanel.tsx"
      provides: "Combined tip and tax configuration panel"
      min_lines: 40
    - path: "src/components/tip-tax/TipSegmentedControl.tsx"
      provides: "iOS-style segmented control for tip presets + custom"
      min_lines: 25
    - path: "src/components/tip-tax/TaxInput.tsx"
      provides: "Tax input with dollar/percentage mode toggle"
      min_lines: 30
    - path: "src/components/tip-tax/SplitMethodToggle.tsx"
      provides: "Reusable equal/proportional toggle for tip and tax"
      min_lines: 15
    - path: "src/components/tip-tax/TipTaxPanel.test.tsx"
      provides: "Component tests for tip/tax controls"
      min_lines: 50
  key_links:
    - from: "src/components/tip-tax/TipTaxPanel.tsx"
      to: "src/store/billStore.ts"
      via: "useBillStore selectors calling setTip() and setTax()"
      pattern: "setTip|setTax"
    - from: "src/components/tip-tax/TipSegmentedControl.tsx"
      to: "src/components/tip-tax/TipTaxPanel.tsx"
      via: "onChange callback computing tip cents from percentage * subtotal"
      pattern: "Math\\.round.*pct.*subtotal"
    - from: "src/components/tip-tax/TaxInput.tsx"
      to: "src/utils/currency.ts"
      via: "dollarsToCents for dollar mode, manual pct calc for percentage mode"
      pattern: "dollarsToCents|pct.*subtotal"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/tip-tax/TipTaxPanel.tsx"
      via: "CSS hidden panel mounting in 'split' tab"
      pattern: "activeTab.*split"
---

<objective>
Build the Tip/Tax configuration panel and wire it into a new 4th "Split" tab in the app shell.

Purpose: Users need to configure how tip and tax are split before seeing the per-person summary. This is the input side of Phase 3 -- the controls that drive the final calculation. The existing store already has `setTip()` and `setTax()` actions; this plan connects UI controls to those actions.

Output: TipTaxPanel with segmented tip control (15/18/20/Custom), tax dollar/percentage input, independent split method toggles for tip and tax, all wired to the Zustand store via `setTip()` and `setTax()`. A 4th "Split" tab in TabBar/AppShell renders the panel.
</objective>

<execution_context>
@/Users/shantnupatil/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantnupatil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-output/03-RESEARCH.md

@src/store/billStore.ts
@src/engine/types.ts
@src/utils/currency.ts
@src/hooks/useSubtotal.ts
@src/components/layout/TabBar.tsx
@src/components/layout/AppShell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tip/tax components and wire to store</name>
  <files>
    src/components/tip-tax/SplitMethodToggle.tsx
    src/components/tip-tax/TipSegmentedControl.tsx
    src/components/tip-tax/TaxInput.tsx
    src/components/tip-tax/TipTaxPanel.tsx
  </files>
  <action>
Create four components in a new `src/components/tip-tax/` directory:

**SplitMethodToggle.tsx** -- Reusable two-option toggle for "Equal" vs "Proportional" split method.
- Props: `value: 'equal' | 'proportional'`, `onChange: (method) => void`, `label: string`
- Render a paired button group inside a `bg-gray-800 rounded-lg` container
- Active option gets `bg-gray-700 text-gray-100`, inactive gets `text-gray-500`
- Used twice in TipTaxPanel: once for tip, once for tax

**TipSegmentedControl.tsx** -- iOS-style segmented control for tip presets.
- Props: `selected: '15' | '18' | '20' | 'custom'`, `customValue: string`, `onPresetChange: (preset) => void`, `onCustomChange: (value: string) => void`
- Render 4 radio-button-backed segments: 15%, 18%, 20%, Custom
- Use hidden `<input type="radio">` with styled `<label>` elements (sr-only pattern)
- Active segment: `bg-blue-600 text-white`, inactive: `text-gray-400 hover:text-gray-200`
- Container: `role="group" aria-label="Tip percentage"`, `bg-gray-800 rounded-lg p-1 gap-1`
- When `selected === 'custom'`, render a text input below the segmented control with `type="text" inputmode="decimal"` and a "%" suffix label. Use the same `filterPriceInput` from `src/utils/currency.ts` but allow digits and single decimal point only (no dollar sign). On blur, call `onCustomChange` with the sanitized value.

**TaxInput.tsx** -- Tax dollar/percentage mode toggle + input.
- Props: `amountDisplay: string`, `mode: 'dollar' | 'percent'`, `onModeChange: (mode) => void`, `onValueChange: (value: string) => void`, `onBlur: () => void`
- Render a paired button group ("$" | "%") to the left of the input field
- Active mode button: `bg-gray-700 text-gray-100`, inactive: `text-gray-500`
- Input: `type="text" inputmode="decimal"`, `min-h-12`, `bg-gray-800 border border-gray-700 rounded-lg`
- On mode switch, clear the input value (avoids confusion between dollar and percentage values)
- Use `filterPriceInput` for dollar mode input filtering. For percent mode, filter to allow only digits, single decimal, and values 0-100 range.

**TipTaxPanel.tsx** -- Combined panel rendering all tip and tax controls.
- Import `useBillStore` with `useShallow` for `setTip`, `setTax`, `config.tip`, `config.tax`
- Import `useSubtotal` hook to get current subtotal in Cents
- **Local state for tip**: `tipPreset` (one of '15'|'18'|'20'|'custom'), `customTipPct` (string). Store the tip *percentage* locally, not the dollar amount. On preset change or custom input blur, compute `tipCents = Math.round((pct / 100) * subtotal)` and call `setTip(tipCents, tipMethod, false)`. This ensures tip auto-updates when subtotal changes (via `useEffect` comparing subtotal).
- **Local state for tax**: `taxMode` ('dollar'|'percent'), `taxInput` (string). On blur in dollar mode, call `dollarsToCents(taxInput)` then `setTax(taxCents, taxMethod, false)`. On blur in percent mode, compute `taxCents = Math.round((pct / 100) * subtotal)` then `setTax(taxCents, taxMethod, false)`.
- **Split method state**: Read `config.tip.method` and `config.tax.method` from store. On change, call `setTip(currentTipCents, newMethod, false)` / `setTax(currentTaxCents, newMethod, false)` passing the current amountCents so it doesn't change.
- **Tip recalculation on subtotal change**: Use a `useEffect` that watches `subtotal` and `tipPreset`/`customTipPct`. When subtotal changes and tip is set as a percentage (not custom-dollar), recompute and call `setTip()`. This solves the "stale tip after item change" pitfall.
- **Layout**: Section header "Tip" with TipSegmentedControl + SplitMethodToggle below. Then section header "Tax" with TaxInput + SplitMethodToggle below. Consistent spacing with `space-y-4` or `space-y-6`.
- Pass `includeZeroFoodPeople: false` to all `setTip`/`setTax` calls (no UI control for this in Phase 3 per research recommendation).
  </action>
  <verify>
Run `npx vitest run` -- all existing 103 tests still pass (no regressions). Run `npx vite build` -- zero TypeScript errors. Manually verify files exist: `ls src/components/tip-tax/` shows all 4 files.
  </verify>
  <done>
Four tip/tax components created. TipSegmentedControl renders 15/18/20/Custom presets with radio-backed segments. TaxInput supports dollar/percent mode toggle. SplitMethodToggle is reusable for both tip and tax. TipTaxPanel wires everything to the store via setTip()/setTax() with local percentage state for live recalculation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 4th "Split" tab and mount TipTaxPanel with tests</name>
  <files>
    src/components/layout/TabBar.tsx
    src/components/layout/AppShell.tsx
    src/components/tip-tax/TipTaxPanel.test.tsx
  </files>
  <action>
**TabBar.tsx** -- Add 'split' to the Tab union type and TABS array:
- Update `export type Tab = 'people' | 'items' | 'assignments' | 'split';`
- Add `{ id: 'split', label: 'Split' }` as the 4th entry in the TABS array
- No other changes needed -- the existing flex layout and styling handles 4 tabs

**AppShell.tsx** -- Mount TipTaxPanel in the new "split" tab:
- Import `TipTaxPanel` from `'../tip-tax/TipTaxPanel'`
- Add a 4th CSS-hidden panel `<div>` after the assignments panel:
  ```
  <div className={activeTab === 'split' ? '' : 'hidden'}>
    <TipTaxPanel />
  </div>
  ```
- This follows the established CSS-hidden mounting pattern (all panels stay mounted)

**TipTaxPanel.test.tsx** -- Component tests with `// @vitest-environment jsdom` directive:
- Test setup: `useBillStore.getState().reset()` in `beforeEach` for test isolation
- Add at least 2 people and 1 assigned item before testing tip/tax (engine needs valid config)
- Test cases:
  1. "renders tip segmented control with 15%, 18%, 20%, Custom options" -- verify all 4 labels visible
  2. "selecting 18% preset calls setTip with correct cents" -- add item ($100), select 18%, verify store tip.amountCents === 1800
  3. "custom tip input computes correct cents" -- select Custom, type "25", blur, verify store tip.amountCents = Math.round(0.25 * subtotal)
  4. "tax dollar mode calls setTax with correct cents" -- type "$12.50" in dollar mode, blur, verify store tax.amountCents === 1250
  5. "switching tax to percent mode clears input" -- set dollar mode value, switch to %, verify input is cleared
  6. "tax percent mode computes correct cents" -- switch to %, type "8.5", blur, verify store tax.amountCents = Math.round(0.085 * subtotal)
  7. "split method toggle changes tip method in store" -- click Proportional for tip, verify store tip.method === 'proportional'
  8. "split method toggle changes tax method independently" -- click Proportional for tax only, verify tip still 'equal' but tax is 'proportional'
- Use `@testing-library/react` render + `@testing-library/user-event` for interactions
- Use `useBillStore.getState()` to read store state assertions (not DOM text)
  </action>
  <verify>
Run `npx vitest run` -- all tests pass (existing 103 + new TipTaxPanel tests). Run `npx vite build` -- zero errors. Verify the Tab type includes 'split': `grep "split" src/components/layout/TabBar.tsx`.
  </verify>
  <done>
The 4th "Split" tab appears in TabBar. AppShell renders TipTaxPanel inside the split tab using the CSS-hidden mounting pattern. 8 component tests verify tip preset selection, custom tip input, tax dollar/percent modes, and independent split method toggles. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass (103 existing + ~8 new = ~111 total)
2. `npx vite build` -- zero TypeScript errors, clean production build
3. Run dev server (`npx vite`) and manually navigate to Split tab:
   - See Tip section with 15%/18%/20%/Custom segmented control
   - Tap 18% -- segment highlights, stays selected
   - Tap Custom -- input appears, type "22", blur -- segment stays on Custom
   - See Tax section with $/% toggle and input field
   - Type "10.50" in dollar mode, blur
   - Switch to % mode -- input clears
   - Type "8.5" in percent mode, blur
   - See separate Equal/Proportional toggles for tip and tax
   - Change tip to Proportional, verify tax stays Equal
</verification>

<success_criteria>
- 4th "Split" tab renders in bottom tab bar alongside People, Items, Assign
- Tip segmented control shows 15/18/20/Custom with exactly one always selected
- Custom tip reveals a percentage input that computes cents against current subtotal
- Tax input supports dollar and percentage modes with a clear $/% toggle
- Switching tax mode clears the input value
- Independent split method toggles for tip and tax
- setTip() and setTax() called with correct computed amountCents on blur/select
- Tip amount auto-updates when subtotal changes (percentage recalculation)
- All existing tests still pass, new component tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-output/03-01-SUMMARY.md`
</output>
