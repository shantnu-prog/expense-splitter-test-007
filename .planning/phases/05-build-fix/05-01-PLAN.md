---
phase: 05-build-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tsconfig.app.json
  - src/components/summary/SummaryPanel.tsx
  - src/store/billStore.ts
autonomous: true
requirements: []
gap_closure: true

must_haves:
  truths:
    - "`npm run build` (tsc -b && vite build) completes with exit code 0"
    - "All 125 existing tests pass with zero failures"
    - "Test files (*.test.ts, *.test.tsx) are excluded from production TypeScript compilation"
  artifacts:
    - path: "tsconfig.app.json"
      provides: "Production TypeScript config excluding test files"
      contains: "exclude"
    - path: "src/components/summary/SummaryPanel.tsx"
      provides: "Type-safe EngineResult handling with explicit narrowing"
    - path: "src/store/billStore.ts"
      provides: "Clean restorePerson loop with no unused variables"
  key_links:
    - from: "tsconfig.app.json"
      to: "src/**/*.test.ts(x)"
      via: "exclude glob pattern"
      pattern: 'exclude.*test'
    - from: "src/components/summary/SummaryPanel.tsx"
      to: "src/utils/formatSummary.ts"
      via: "formatSummary(result, people) call with EngineSuccess type"
      pattern: "formatSummary.*as EngineSuccess|result as EngineSuccess"
---

<objective>
Fix the three root causes of TypeScript compilation errors that prevent `npm run build` from succeeding.

Purpose: The production build (`tsc -b && vite build`) fails with 100+ errors, blocking v1.0 release. All errors trace to three root causes: test files included in tsc -b compilation, unnarrowed discriminated union access in SummaryPanel.tsx, and an unused variable in billStore.ts.

Output: A clean `npm run build` with zero errors and all 125 existing tests still passing.
</objective>

<execution_context>
@/Users/shantnupatil/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantnupatil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.0-MILESTONE-AUDIT.md

@tsconfig.app.json
@src/components/summary/SummaryPanel.tsx
@src/store/billStore.ts
@src/engine/types.ts
@src/utils/formatSummary.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Exclude test files from tsconfig.app.json and fix TypeScript type errors</name>
  <files>tsconfig.app.json, src/components/summary/SummaryPanel.tsx, src/store/billStore.ts</files>
  <action>
Three targeted edits to fix all TypeScript compilation errors:

**1. tsconfig.app.json — Exclude test files from production build**

Add an `"exclude"` array after the `"include"` array:
```json
"exclude": ["src/**/*.test.ts", "src/**/*.test.tsx"]
```
This prevents tsc -b from compiling test files (which use Vitest globals like `describe`, `it`, `expect`, `beforeEach`) during the production build. The test files are still compiled by Vitest using tsconfig.node.json / vitest.config.ts. This is the standard Vite scaffold pattern — `tsconfig.app.json` is for production code only.

**2. src/components/summary/SummaryPanel.tsx — Narrow EngineResult before accessing EngineSuccess members**

The `result` variable is typed as `EngineResult` (discriminated union: `EngineSuccess | EngineError`). After the `if (!result.ok) { return ... }` early return on line 40, TypeScript should narrow `result` to `EngineSuccess`, but it doesn't when `result` is accessed inside closures (`handleCopyAll`, `handlePersonCopy`) defined later in the same scope.

Fix: After the early-return guard (after line 52), add a const re-assignment that explicitly narrows the type. Either:
- Option A (preferred): `const successResult = result as EngineSuccess;` — then use `successResult` for all subsequent accesses (`.results`, `.totalSurplusCents`, and `formatSummary(successResult, people)`).
- Option B: `const successResult: EngineSuccess = result;` — TypeScript will accept this since the early return narrows the type in the main flow.

Replace all subsequent references to `result.results`, `result.totalSurplusCents`, and `formatSummary(result, ...)` with `successResult.results`, `successResult.totalSurplusCents`, and `formatSummary(successResult, ...)` respectively.

The `formatSummary` function expects `EngineSuccess` (not `EngineResult`), so this also fixes that type mismatch.

**3. src/store/billStore.ts — Remove unused variable in restorePerson**

On line 128, the `for...of` loop destructures `[itemId, personIds]` from `Object.entries(assignments)`, but `personIds` is never used (only `person.id` is referenced in the loop body). With `noUnusedLocals: true`, this is a compile error.

Fix: Change the destructuring to only extract the key:
```typescript
for (const [itemId] of Object.entries(assignments) as [ItemId, PersonId[]][]) {
```

This drops `personIds` from the destructuring since it's unused — the loop body only needs `itemId` to look up and modify `state.config.assignments[itemId]`.

Note: The variable name `itemId` in the for-loop shadows the imported `itemId` constructor function. This is safe because the imported `itemId` is not used inside `restorePerson`. If TypeScript flags this shadowing (unlikely since `noUnusedLocals` targets variables, not imports), rename the loop variable to `restoredItemId`.
  </action>
  <verify>
Run both commands and confirm zero errors:
1. `npm run build` — must complete with exit code 0 (runs `tsc -b && vite build`)
2. `npx vitest run` — all 125 tests must pass with zero failures

Additionally verify:
3. `npx tsc -b --listFiles 2>/dev/null | grep -c '\.test\.'` — should output `0` (no test files in production compilation)
  </verify>
  <done>
- `npm run build` exits 0 with zero TypeScript errors
- All 125 existing tests pass (zero regressions)
- No test files appear in `tsc -b` file list
- SummaryPanel.tsx uses explicitly narrowed EngineSuccess type
- billStore.ts restorePerson loop has no unused variables
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes with exit code 0 — zero TypeScript compilation errors, zero Vite bundle errors
2. `npx vitest run` — 125 tests pass, 0 failures, 0 skipped
3. Test files are excluded from production TS compilation (verify with `tsc -b --listFiles`)
4. No new `as any` casts or `@ts-ignore` comments introduced
</verification>

<success_criteria>
- Production build (`npm run build` which runs `tsc -b && vite build`) completes with zero errors
- All 125 existing tests still pass with zero regressions
- Test files are excluded from production TypeScript compilation
- Changes are minimal and targeted — only the three root causes from the audit are addressed
</success_criteria>

<output>
After completion, create `.planning/phases/05-build-fix/05-01-SUMMARY.md`
</output>
