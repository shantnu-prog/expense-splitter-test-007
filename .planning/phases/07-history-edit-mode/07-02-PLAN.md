---
phase: 07-history-edit-mode
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/layout/AppShell.tsx
  - src/components/summary/SummaryPanel.tsx
autonomous: true
requirements:
  - HIST-02

must_haves:
  truths:
    - "User taps a history entry and the full bill (people, items, assignments, tip, tax) is restored into the editor with an Editing saved split indicator visible"
    - "Save Split button in SummaryPanel saves a new split to history when currentSplitId is null"
    - "Update Split button in SummaryPanel updates the existing history entry when currentSplitId is non-null"
    - "After saving a new split, the button label switches from Save Split to Update Split"
    - "Editing indicator shows the saved date and is visible across all editor tabs when editing a saved split"
  artifacts:
    - path: "src/components/summary/SummaryPanel.tsx"
      provides: "Save Split / Update Split button that persists the current bill to history"
      exports: ["SummaryPanel"]
    - path: "src/components/layout/AppShell.tsx"
      provides: "Editing indicator banner visible when currentSplitId is non-null"
      exports: ["AppShell"]
  key_links:
    - from: "src/components/summary/SummaryPanel.tsx"
      to: "src/store/historyStore.ts"
      via: "import useHistoryStore for save and update actions"
      pattern: "import.*useHistoryStore.*from.*store/historyStore"
    - from: "src/components/summary/SummaryPanel.tsx"
      to: "src/store/billStore.ts"
      via: "read currentSplitId and call setCurrentSplitId after save"
      pattern: "currentSplitId"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/store/billStore.ts"
      via: "read currentSplitId for editing indicator visibility"
      pattern: "currentSplitId"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/store/historyStore.ts"
      via: "read splits to find savedAt date for editing indicator"
      pattern: "useHistoryStore"
---

<objective>
Add the Save/Update button to SummaryPanel and the editing indicator to AppShell so users can persist their splits and clearly see when they are editing a previously saved split.

Purpose: The history panel from 07-01 allows loading saved splits. This plan completes the edit cycle: users see a clear "Editing saved split" indicator when working on a loaded split, and can save new splits or update existing ones from the Split tab. The save/update flow uses the existing historyStore.save() and historyStore.update() actions built in Phase 6.

Output: SummaryPanel has a save/update button that changes label based on editing state. An editing indicator banner appears below the SubtotalBar when editing a saved split.
</objective>

<execution_context>
@/Users/shantnupatil/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantnupatil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-history-edit-mode/07-RESEARCH.md
@.planning/phases/07-history-edit-mode/07-01-PLAN.md

@src/store/historyStore.ts
@src/store/billStore.ts
@src/components/summary/SummaryPanel.tsx
@src/components/summary/Toast.tsx
@src/components/layout/AppShell.tsx
@src/hooks/useCopyToClipboard.ts
@src/utils/currency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Save/Update Split button to SummaryPanel</name>
  <files>
    src/components/summary/SummaryPanel.tsx
  </files>
  <action>
Modify `SummaryPanel.tsx` to add a save/update button and toast feedback.

**1. Add imports:**
```typescript
import { useHistoryStore } from '../../store/historyStore';
```

**2. Read currentSplitId from billStore** (add to the existing `useShallow` selector):
```typescript
const { getResult, people, tipCents, taxCents, config, currentSplitId, setCurrentSplitId } = useBillStore(
  useShallow((s) => ({
    getResult: s.getResult,
    people: s.config.people,
    tipCents: s.config.tip.amountCents,
    taxCents: s.config.tax.amountCents,
    config: s.config,
    currentSplitId: s.currentSplitId,
    setCurrentSplitId: s.setCurrentSplitId,
  }))
);
```

**3. Add a state for save toast** (reuse the existing `useCopyToClipboard` pattern or add a separate state):
```typescript
const [saveToastMessage, setSaveToastMessage] = useState('');
const [showSaveToast, setShowSaveToast] = useState(false);

function flashSaveToast(message: string) {
  setSaveToastMessage(message);
  setShowSaveToast(true);
  setTimeout(() => setShowSaveToast(false), 2000);
}
```

**4. Save/Update handler:**
```typescript
function handleSave() {
  if (currentSplitId) {
    // Update existing split
    useHistoryStore.getState().update(currentSplitId, config);
    flashSaveToast('Split updated');
  } else {
    // Save new split
    const newId = useHistoryStore.getState().save(config);
    setCurrentSplitId(newId);
    flashSaveToast('Split saved');
  }
}
```

**5. Render the Save/Update button** — place it AFTER the "Copy summary" button, inside a new div:
```tsx
{/* Save / Update split button */}
<div className="px-4 pb-4">
  <button
    onClick={handleSave}
    className="w-full bg-gray-800 text-gray-100 font-medium rounded-xl min-h-12 border border-gray-700 active:bg-gray-700"
  >
    {currentSplitId ? 'Update Split' : 'Save Split'}
  </button>
</div>
```

The Save/Update button uses a secondary style (gray-800 bg, border) to visually distinguish it from the primary "Copy summary" button (blue-600 bg).

**6. Add save toast** — render alongside the existing copy toast:
```tsx
<Toast message={saveToastMessage} visible={showSaveToast} />
```

Note: If two Toast components conflict visually, give the save toast a slightly different bottom position. Check the existing Toast component's positioning (bottom-20) and adjust if needed — or reuse the same single Toast by managing message/visible state for both copy and save through one state pair. Simplest approach: use a single toast state pair shared between copy and save actions. Replace `useCopyToClipboard` with direct state:

Actually, the simplest approach is to keep the existing `useCopyToClipboard` hook for copy operations and add the save toast as additional state. Since both use the same `<Toast>` component and only one should show at a time, combine them:

```typescript
// Unify toast state — only one toast at a time
const [toastMsg, setToastMsg] = useState('');
const [toastVisible, setToastVisible] = useState(false);
const toastTimer = useRef<ReturnType<typeof setTimeout>>();

function showToast(message: string) {
  if (toastTimer.current) clearTimeout(toastTimer.current);
  setToastMsg(message);
  setToastVisible(true);
  toastTimer.current = setTimeout(() => setToastVisible(false), 2000);
}
```

Then use `showToast('Copied!')` for copy and `showToast('Split saved')` / `showToast('Split updated')` for save. This replaces the `useCopyToClipboard` hook usage — instead call `navigator.clipboard.writeText(text).then(() => showToast('Summary copied!'))` directly in `handleCopyAll` and `handlePersonCopy`.

Render one `<Toast>`:
```tsx
<Toast message={toastMsg} visible={toastVisible} />
```
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run` — all tests pass.
  </verify>
  <done>
SummaryPanel has a Save Split / Update Split button that changes label based on currentSplitId. Save creates a new history entry and switches to Update mode. Update overwrites the existing entry. Toast feedback confirms the action.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add editing indicator to AppShell</name>
  <files>
    src/components/layout/AppShell.tsx
  </files>
  <action>
Add an editing indicator banner that appears when `currentSplitId` is non-null. This tells users they are modifying a previously saved split.

**1. Read currentSplitId from billStore** in AppShell (add to the existing useShallow selector or use a separate selector):
```typescript
const currentSplitId = useBillStore((s) => s.currentSplitId);
```

**2. Read the matching split's savedAt** from historyStore (only when editing):
```typescript
const editingSplit = useHistoryStore((s) =>
  currentSplitId ? s.splits.find((sp) => sp.id === currentSplitId) : undefined
);
```

**3. Format the date** for display:
```typescript
const editingDate = editingSplit
  ? new Intl.DateTimeFormat(undefined, { month: 'short', day: 'numeric' }).format(new Date(editingSplit.savedAt))
  : '';
```

**4. Render the indicator** — place it between SubtotalBar and the main panel area. Only show when `currentSplitId` is non-null AND the active tab is NOT 'history':
```tsx
{currentSplitId && activeTab !== 'history' && (
  <div className="px-4 py-2 bg-blue-950/50 border-b border-blue-900/50 flex items-center justify-between">
    <span className="text-blue-300 text-xs font-medium">
      Editing saved split{editingDate ? ` from ${editingDate}` : ''}
    </span>
    <button
      onClick={() => setActiveTab('history')}
      className="text-blue-400 text-xs font-medium min-h-8 px-2"
    >
      Back to History
    </button>
  </div>
)}
```

The indicator uses a subtle blue background (blue-950/50) to distinguish it from the main content. It includes a "Back to History" link for quick navigation.

The indicator is placed INSIDE the flex-col layout, after SubtotalBar (which is already conditionally hidden for history tab). It does NOT take space in the history tab.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run` — all tests pass.
Run `npm run build` — production build succeeds.
  </verify>
  <done>
Editing indicator banner appears below SubtotalBar when editing a saved split. Shows "Editing saved split from [date]" with a "Back to History" link. Hidden on the history tab and when not editing a saved split.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` — all tests pass
3. `npm run build` — production build succeeds
4. Browser: create a bill with people + items + assignments → go to Split tab → see "Save Split" button below "Copy summary"
5. Browser: tap "Save Split" → toast shows "Split saved" → button label changes to "Update Split"
6. Browser: edit an item price → tap "Update Split" → toast shows "Split updated"
7. Browser: refresh → history tab shows the saved entry → tap it → lands on People tab with data restored → "Editing saved split from [date]" indicator visible at top
8. Browser: tap "Back to History" in the indicator → returns to history tab
9. Browser: tap "New Split" in history → indicator disappears, clean empty bill on People tab
</verification>

<success_criteria>
- Save Split button creates new history entry and switches to Update mode
- Update Split button updates the existing history entry in place
- Toast feedback confirms save/update
- Editing indicator visible on all editor tabs when editing a saved split
- Editing indicator shows the date of the saved split
- Back to History link in indicator navigates to history tab
- After reset (New Split), indicator disappears and button shows "Save Split"
</success_criteria>

<output>
After completion, create `.planning/phases/07-history-edit-mode/07-02-SUMMARY.md`
</output>
