---
phase: 07-history-edit-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useUndoDelete.ts
  - src/components/history/HistoryRow.tsx
  - src/components/history/HistoryPanel.tsx
  - src/components/layout/TabBar.tsx
  - src/components/layout/AppShell.tsx
autonomous: true
requirements:
  - HIST-01
  - HIST-03
  - HIST-04

must_haves:
  truths:
    - "User with saved splits opens the app and sees a history list showing date, people names, and total for each entry — without having to navigate anywhere"
    - "User with no saved history sees an empty state with a New Split CTA rather than a blank screen"
    - "User deletes a saved split and sees an undo toast; tapping undo within 5 seconds restores the entry exactly as it was"
    - "User on the history screen taps New Split and gets a clean empty bill editor on the People tab"
    - "History tab appears in the bottom tab bar and is the initial tab when saved splits exist"
  artifacts:
    - path: "src/components/history/HistoryRow.tsx"
      provides: "Single history entry row displaying formatted date, people names, and total"
      exports: ["HistoryRow"]
    - path: "src/components/history/HistoryPanel.tsx"
      provides: "History list panel with empty state, delete with undo, New Split button, and tap-to-load"
      exports: ["HistoryPanel"]
    - path: "src/hooks/useUndoDelete.ts"
      provides: "Extended DeletedSnapshot union with DeletedSplit kind for history entry deletion"
      exports: ["useUndoDelete", "DeletedSplit", "DeletedSnapshot"]
    - path: "src/components/layout/TabBar.tsx"
      provides: "Tab type extended with 'history' and new tab button rendered"
      exports: ["Tab", "TabBar"]
    - path: "src/components/layout/AppShell.tsx"
      provides: "HistoryPanel mounted with CSS hidden pattern; initial tab set to history when splits exist"
      exports: ["AppShell"]
  key_links:
    - from: "src/components/history/HistoryPanel.tsx"
      to: "src/store/historyStore.ts"
      via: "import useHistoryStore for splits list, remove, restore actions"
      pattern: "import.*useHistoryStore.*from.*store/historyStore"
    - from: "src/components/history/HistoryPanel.tsx"
      to: "src/store/billStore.ts"
      via: "import useBillStore for loadConfig, setCurrentSplitId, reset actions"
      pattern: "import.*useBillStore.*from.*store/billStore"
    - from: "src/components/history/HistoryRow.tsx"
      to: "src/engine/engine.ts"
      via: "import computeSplit to derive total for display"
      pattern: "import.*computeSplit.*from.*engine/engine"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/history/HistoryPanel.tsx"
      via: "import and mount HistoryPanel in CSS-hidden panel block"
      pattern: "import.*HistoryPanel.*from.*history/HistoryPanel"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/store/historyStore.ts"
      via: "import useHistoryStore to read splits.length for initial tab logic"
      pattern: "import.*useHistoryStore.*from.*store/historyStore"
---

<objective>
Build the history list UI, integrate it into the tab bar and AppShell, and implement delete-with-undo for history entries.

Purpose: Users need to see their saved splits when they open the app, delete entries they no longer want with a 5-second undo window, and start fresh splits from the history screen. This plan creates the HistoryPanel and HistoryRow components, extends the existing useUndoDelete hook with a DeletedSplit kind, adds a 'history' tab to the tab bar, and mounts the new panel in AppShell with the CSS-hidden pattern.

Output: A working history screen accessible via the bottom tab bar, showing saved splits with date/people/total, empty state for no history, delete with undo toast, and a New Split button.
</objective>

<execution_context>
@/Users/shantnupatil/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantnupatil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-history-edit-mode/07-RESEARCH.md

@src/store/historyStore.ts
@src/store/billStore.ts
@src/hooks/useUndoDelete.ts
@src/components/shared/UndoToast.tsx
@src/components/layout/AppShell.tsx
@src/components/layout/TabBar.tsx
@src/engine/types.ts
@src/engine/engine.ts
@src/utils/currency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useUndoDelete with DeletedSplit kind</name>
  <files>
    src/hooks/useUndoDelete.ts
  </files>
  <action>
Add a `DeletedSplit` interface to the existing `useUndoDelete.ts` file and extend the `DeletedSnapshot` union type.

**Add this interface** (after the existing `DeletedItem` interface):

```typescript
export interface DeletedSplit {
  kind: 'savedSplit';
  split: SavedSplit;
}
```

Import `SavedSplit` from `../store/historyStore`.

**Update the union type:**
```typescript
export type DeletedSnapshot = DeletedPerson | DeletedItem | DeletedSplit;
```

**Update the `toastMessage` function** to handle the new kind:
```typescript
if (snap.kind === 'savedSplit') {
  const peopleCount = snap.split.config.people.length;
  const date = new Intl.DateTimeFormat(undefined, { month: 'short', day: 'numeric' }).format(new Date(snap.split.savedAt));
  return `Deleted split from ${date} (${peopleCount} ${peopleCount !== 1 ? 'people' : 'person'})`;
}
```

Do NOT change any other logic in the hook — the timer, scheduleDelete, handleUndo, and dismiss functions work generically with any DeletedSnapshot kind.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run` — all existing tests still pass.
  </verify>
  <done>
DeletedSplit interface exists, DeletedSnapshot union includes it, toastMessage handles 'savedSplit' kind. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HistoryRow component</name>
  <files>
    src/components/history/HistoryRow.tsx
  </files>
  <action>
Create `src/components/history/` directory and `HistoryRow.tsx`.

**Props interface:**
```typescript
interface HistoryRowProps {
  split: SavedSplit;
  onLoad: (split: SavedSplit) => void;
  onDelete: (split: SavedSplit) => void;
}
```

**Implementation:**

1. **Date display:** Format `split.savedAt` using `new Intl.DateTimeFormat(undefined, { month: 'short', day: 'numeric' }).format(new Date(split.savedAt))`.

2. **People names:** Extract from `split.config.people`. Show first 2 names joined by ", ". If more than 2 people, append ` +${remaining}`. If no people, show "No people".

3. **Total display:** Call `computeSplit(split.config)`. If `result.ok`, sum `result.results.reduce((s, r) => s + r.roundedTotalCents, 0)` and display with `centsToDollars()`. If `!result.ok`, show "—" (incomplete split).

4. **Layout:** A `<button>` element (the entire row is tappable) with:
   - Left side: date on top line (text-sm text-gray-400), people names below (text-base text-gray-100 font-medium)
   - Right side: total amount (text-lg text-white font-semibold tabular-nums) and a delete button (× icon)
   - The delete button uses `e.stopPropagation()` to prevent triggering the row load
   - Min-h-16 for comfortable touch target
   - Border-b border-gray-800 divider between rows
   - bg-gray-900/50 with hover:bg-gray-800 transition

5. **Delete button:** Small `<button>` on the right with `onClick={(e) => { e.stopPropagation(); onDelete(split); }}`. Uses text-gray-500 hover:text-red-400. Min touch target min-w-11 min-h-11.

6. **Row tap:** `onClick={() => onLoad(split)}` on the outer button.

Import `SavedSplit` from `../../store/historyStore`, `computeSplit` from `../../engine/engine`, `centsToDollars` from `../../utils/currency`, and `cents` from `../../engine/types`.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>
HistoryRow component exists at src/components/history/HistoryRow.tsx. Displays formatted date, people names (with +N overflow), computed total, and has separate tap targets for load (whole row) and delete (× button).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create HistoryPanel component</name>
  <files>
    src/components/history/HistoryPanel.tsx
  </files>
  <action>
Create `src/components/history/HistoryPanel.tsx`.

**Props interface:**
```typescript
interface HistoryPanelProps {
  onTabChange: (tab: Tab) => void;
}
```

Import `Tab` from `../layout/TabBar`.

**Implementation:**

1. **Read splits** from `useHistoryStore((s) => s.splits)`.

2. **Undo hook:** Instantiate `useUndoDelete()` for history deletion.

3. **Delete handler:**
```typescript
function handleDelete(split: SavedSplit) {
  useHistoryStore.getState().remove(split.id);
  undo.scheduleDelete({ kind: 'savedSplit', split });
}
```

4. **Undo handler:**
```typescript
function handleUndo() {
  const snap = undo.handleUndo(undo.snapshot);
  if (snap?.kind === 'savedSplit') {
    useHistoryStore.getState().restore(snap.split);
  }
}
```

5. **Load handler:**
```typescript
function handleLoad(split: SavedSplit) {
  useBillStore.getState().loadConfig(split.config);
  useBillStore.getState().setCurrentSplitId(split.id);
  onTabChange('people');
}
```

6. **New Split handler:**
```typescript
function handleNewSplit() {
  useBillStore.getState().reset();
  onTabChange('people');
}
```

7. **Empty state** (when `splits.length === 0`):
```tsx
<div className="flex flex-col items-center justify-center px-6 py-16 text-center">
  <p className="text-gray-400 text-base mb-2">No saved splits yet</p>
  <p className="text-gray-500 text-sm mb-6">Split a bill and save it to see it here</p>
  <button
    onClick={handleNewSplit}
    className="px-6 py-3 bg-blue-600 text-white font-medium rounded-xl min-h-12 active:bg-blue-700"
  >
    New Split
  </button>
</div>
```

8. **List state** (when `splits.length > 0`):
```tsx
<div className="flex flex-col">
  {/* Header with New Split button */}
  <div className="px-4 py-3 border-b border-gray-800 flex items-center justify-between">
    <h2 className="text-gray-400 text-sm font-medium">Saved Splits</h2>
    <button
      onClick={handleNewSplit}
      className="text-blue-400 text-sm font-medium min-h-11 px-2"
    >
      + New Split
    </button>
  </div>
  {/* Scrollable split list */}
  <div className="flex-1">
    {splits.map((split) => (
      <HistoryRow
        key={split.id}
        split={split}
        onLoad={handleLoad}
        onDelete={handleDelete}
      />
    ))}
  </div>
</div>
```

9. **UndoToast** at the bottom:
```tsx
<UndoToast
  message={undo.message}
  visible={undo.visible}
  onUndo={handleUndo}
  onDismiss={undo.dismiss}
/>
```

Import `useHistoryStore`, `SavedSplit` from `../../store/historyStore`, `useBillStore` from `../../store/billStore`, `useUndoDelete` from `../../hooks/useUndoDelete`, `UndoToast` from `../shared/UndoToast`, `HistoryRow` from `./HistoryRow`.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>
HistoryPanel component exists with empty state (New Split CTA), list view (rows + header), delete with undo toast, load-split handler, and new-split handler. Receives onTabChange prop for navigation.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add history tab to TabBar and mount HistoryPanel in AppShell</name>
  <files>
    src/components/layout/TabBar.tsx
    src/components/layout/AppShell.tsx
  </files>
  <action>
**TabBar.tsx changes:**

1. Extend the `Tab` type to include `'history'`:
```typescript
export type Tab = 'history' | 'people' | 'items' | 'assignments' | 'split';
```

2. Add history to the front of the `TABS` array:
```typescript
const TABS: { id: Tab; label: string }[] = [
  { id: 'history', label: 'History' },
  { id: 'people', label: 'People' },
  { id: 'items', label: 'Items' },
  { id: 'assignments', label: 'Assign' },
  { id: 'split', label: 'Split' },
];
```

No other changes to TabBar — the roving tabindex keyboard navigation handles any number of tabs automatically.

**AppShell.tsx changes:**

1. Import `HistoryPanel` and `useHistoryStore`:
```typescript
import { HistoryPanel } from '../history/HistoryPanel';
import { useHistoryStore } from '../../store/historyStore';
```

2. Change the initial tab state to be computed from history:
```typescript
const [activeTab, setActiveTab] = useState<Tab>(() => {
  const hasSplits = useHistoryStore.getState().splits.length > 0;
  return hasSplits ? 'history' : 'people';
});
```

This uses `getState()` (not a hook subscription) because we only need the value once at initialization. The state initializer callback runs once on first render.

3. Mount HistoryPanel in the panel area, BEFORE the existing panels:
```tsx
<div className={activeTab === 'history' ? '' : 'hidden'}>
  <HistoryPanel onTabChange={setActiveTab} />
</div>
```

4. The SubtotalBar should be hidden when on the history tab (no active bill to show total for). Wrap SubtotalBar with a conditional:
```tsx
{activeTab !== 'history' && <SubtotalBar />}
```

All other panels remain unchanged — CSS hidden class continues to work the same.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run` — all tests pass.
Run `npm run build` — production build succeeds.
  </verify>
  <done>
Tab type includes 'history'. TabBar renders 5 tabs with History first. AppShell mounts HistoryPanel with CSS hidden pattern. Initial tab is 'history' when saved splits exist, 'people' otherwise. SubtotalBar hidden on history tab. All tests pass and build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` — all existing tests pass (no regressions)
3. `npm run build` — production build succeeds
4. Browser: open app with no saved splits → see People tab (no history tab as default)
5. Browser: manually save a split (via console: `useHistoryStore.getState().save(useBillStore.getState().config)`) → refresh → see History tab with the entry showing date, names, total
6. Browser: delete the entry → undo toast appears → tap Undo → entry is restored
7. Browser: tap "New Split" → lands on People tab with empty bill
</verification>

<success_criteria>
- History tab exists in bottom nav bar
- History panel shows saved splits with date, people names, and total
- Empty state shows "No saved splits yet" with New Split button
- Delete shows 5-second undo toast; undo restores the entry exactly
- New Split resets the bill and navigates to People tab
- Initial tab is history when splits exist, people otherwise
- SubtotalBar is hidden when on history tab
</success_criteria>

<output>
After completion, create `.planning/phases/07-history-edit-mode/07-01-SUMMARY.md`
</output>
