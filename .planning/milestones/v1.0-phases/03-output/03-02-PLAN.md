---
phase: 03-output
plan: "02"
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/components/layout/AppShell.tsx
  - src/components/summary/SummaryPanel.tsx
  - src/components/summary/PersonCard.tsx
  - src/components/summary/RoundingFooter.tsx
  - src/components/summary/CopyButton.tsx
  - src/components/summary/Toast.tsx
  - src/components/summary/SummaryPanel.test.tsx
  - src/hooks/useCopyToClipboard.ts
  - src/utils/formatSummary.ts
  - src/utils/formatSummary.test.ts
autonomous: false
requirements:
  - SUMM-01
  - SUMM-03

must_haves:
  truths:
    - "User sees a bill total at the top of the Split tab for receipt comparison"
    - "User sees a vertically stacked card for each person showing their name and rounded total"
    - "User can tap a person card to expand it and see food subtotal, tip share, and tax share"
    - "Rounding surplus footer appears below cards only when surplus is greater than $0.00"
    - "User can tap 'Copy summary' to copy a labeled breakdown to clipboard and see a toast confirmation"
    - "User can tap the copy icon on an individual person card to copy just that person's amount"
    - "If items are unassigned, the Split tab shows a friendly error instead of the summary"
  artifacts:
    - path: "src/components/summary/SummaryPanel.tsx"
      provides: "Bill total header + person cards + rounding footer + copy-all button"
      min_lines: 40
    - path: "src/components/summary/PersonCard.tsx"
      provides: "Collapsible card with name/total header and food/tip/tax detail drawer"
      min_lines: 30
    - path: "src/components/summary/RoundingFooter.tsx"
      provides: "Surplus display hidden when $0.00"
      min_lines: 8
    - path: "src/components/summary/Toast.tsx"
      provides: "Fixed-position toast notification with opacity transition"
      min_lines: 10
    - path: "src/components/summary/CopyButton.tsx"
      provides: "Reusable copy icon button"
      min_lines: 8
    - path: "src/hooks/useCopyToClipboard.ts"
      provides: "Clipboard write + toast state hook"
      min_lines: 15
    - path: "src/utils/formatSummary.ts"
      provides: "Build clipboard text from EngineSuccess + Person[]"
      min_lines: 15
    - path: "src/utils/formatSummary.test.ts"
      provides: "Unit tests for formatSummary and formatPersonSummary"
      min_lines: 30
  key_links:
    - from: "src/components/summary/SummaryPanel.tsx"
      to: "src/store/billStore.ts"
      via: "useBillStore calling getResult() once per render"
      pattern: "getResult"
    - from: "src/components/summary/SummaryPanel.tsx"
      to: "src/utils/formatSummary.ts"
      via: "formatSummary() called in copy-all handler"
      pattern: "formatSummary"
    - from: "src/hooks/useCopyToClipboard.ts"
      to: "navigator.clipboard.writeText"
      via: "synchronous clipboard write from click handler (Safari requirement)"
      pattern: "navigator\\.clipboard\\.writeText"
    - from: "src/components/summary/PersonCard.tsx"
      to: "src/utils/currency.ts"
      via: "centsToDollars for display, cents() wrapper for branded type"
      pattern: "centsToDollars|cents\\("
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/summary/SummaryPanel.tsx"
      via: "SummaryPanel rendered inside split tab alongside TipTaxPanel"
      pattern: "SummaryPanel"
---

<objective>
Build the per-person summary panel with expandable detail cards, rounding transparency footer, and copy-to-clipboard functionality -- the visible output of the entire bill-splitting app.

Purpose: This is the app's entire purpose -- showing users what each person owes. The engine and store already compute everything; this plan renders the results and enables sharing via clipboard copy. The rounding surplus footer provides transparency into the round-up math.

Output: SummaryPanel showing bill total, per-person cards (expandable with food/tip/tax detail), rounding surplus footer (hidden when zero), "Copy summary" button, individual person copy icons, toast notification for copy feedback. All wired into the existing "Split" tab created by Plan 03-01.
</objective>

<execution_context>
@/Users/shantnupatil/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantnupatil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-output/03-RESEARCH.md
@.planning/phases/03-output/03-01-SUMMARY.md

@src/store/billStore.ts
@src/engine/types.ts
@src/utils/currency.ts
@src/hooks/useSubtotal.ts
@src/components/layout/AppShell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create summary components, formatSummary utility, and useCopyToClipboard hook</name>
  <files>
    src/utils/formatSummary.ts
    src/hooks/useCopyToClipboard.ts
    src/components/summary/Toast.tsx
    src/components/summary/CopyButton.tsx
    src/components/summary/RoundingFooter.tsx
    src/components/summary/PersonCard.tsx
    src/components/summary/SummaryPanel.tsx
  </files>
  <action>
Create a utility, a hook, and five components:

**src/utils/formatSummary.ts** -- Pure utility to build clipboard text:
- `formatSummary(result: EngineSuccess, people: Person[]): string` -- Builds the labeled breakdown format per user decision: `"Bill Split:\n- Alice owes $23.50\n- Bob owes $18.00\nTotal: $41.50 (includes tip + tax)"`. Map each `PersonResult` to a person name via `people.find()`, format `roundedTotalCents` via `centsToDollars()`. Compute total as sum of all `roundedTotalCents`, wrap with `cents()` before passing to `centsToDollars`.
- `formatPersonSummary(result: PersonResult, name: string): string` -- Returns `"Alice owes $23.50"` for individual copy. Uses `centsToDollars(result.roundedTotalCents)`.
- Import `centsToDollars` from `../utils/currency`, `cents` from `../engine/types`, types `EngineSuccess`, `Person`, `PersonResult` from `../engine/types`.

**src/hooks/useCopyToClipboard.ts** -- Clipboard + toast state hook:
- Returns `{ copy, showToast, toastMessage }`.
- `copy(text: string, message = 'Copied!')` -- Calls `navigator.clipboard.writeText(text)` SYNCHRONOUSLY from the call site (no awaits before writeText -- Safari user-gesture requirement). On success `.then()`, set `toastMessage` and `showToast = true`, then `setTimeout(() => setShowToast(false), 2000)`.
- On `.catch()`, silently fail for v1 (user is on HTTPS/localhost).
- Use `useCallback` for `copy` to keep stable reference.

**src/components/summary/Toast.tsx** -- Simple fixed-position toast:
- Props: `message: string`, `visible: boolean`.
- Renders a `role="status" aria-live="polite"` div.
- Position: `fixed bottom-20 left-1/2 -translate-x-1/2` (clears the tab bar at bottom-0).
- Style: `bg-gray-800 text-gray-100 text-sm font-medium px-4 py-2 rounded-full shadow-lg`.
- Visibility: `transition-opacity duration-300 pointer-events-none`, `opacity-100` when visible, `opacity-0` when not.

**src/components/summary/CopyButton.tsx** -- Reusable copy icon button:
- Props: `onClick: () => void`, `ariaLabel: string`.
- Renders a `<button>` with a clipboard SVG icon (use a simple inline SVG -- a rectangle with folded corner, ~16x16). Style: `text-gray-500 hover:text-gray-300 min-w-8 min-h-8 flex items-center justify-center`.
- Calls `e.stopPropagation()` before `onClick()` -- critical to prevent toggling the parent card's expanded state.

**src/components/summary/RoundingFooter.tsx** -- Surplus display:
- Props: `surplusCents: number`.
- Only rendered by parent when `surplusCents > 0` (parent hides when zero per user decision).
- Renders: `+$X.XX rounding surplus (cents rounded up per person)` in `text-gray-500 text-xs text-center`.
- Wrap `surplusCents` with `cents()` before passing to `centsToDollars()` for branded type safety.
- Container: `mt-2 px-4 py-3 bg-gray-900/50 rounded-xl`.

**src/components/summary/PersonCard.tsx** -- Expandable person card:
- Props: `person: Person`, `result: PersonResult`, `onCopy: (personId: PersonId) => void`.
- Local `useState(false)` for `expanded`.
- **Header row** (always visible, is a `<button>` for tap expand/collapse):
  - Left: person name in `text-gray-100 font-medium`
  - Right: dollar amount in `text-white font-semibold tabular-nums text-lg` via `centsToDollars(result.roundedTotalCents)`, then a CopyButton (with `e.stopPropagation()`), then a chevron indicator that rotates 180 on expand (`transition-transform duration-200`).
  - Use a simple inline SVG chevron or Unicode character for the expand indicator.
- **Detail drawer** (expand/collapse animation):
  - Use CSS `grid-rows` transition: container `<div>` with `className="grid transition-[grid-template-rows] duration-200 ease-out"` and inline `style={{ gridTemplateRows: expanded ? '1fr' : '0fr' }}`.
  - Inner `<div className="overflow-hidden">` wrapping the detail content.
  - Detail content: three rows showing Food, Tip, Tax -- each as `flex justify-between text-sm` with gray-400 label and gray-200 tabular-nums value.
  - Wrap `result.foodCents`, `result.tipCents`, `result.taxCents` with `cents()` before passing to `centsToDollars()` (they're typed as `number`, not `Cents` -- see Pitfall 4 in research).
- Card container: `bg-gray-900 border border-gray-800 rounded-xl mb-3`.

**src/components/summary/SummaryPanel.tsx** -- Main summary panel:
- Import `useBillStore` with `useShallow` to select `getResult` and `config.people`.
- Call `getResult()` ONCE at the top of the component (not in children -- Pitfall 3).
- **Error state**: If `!result.ok`, render a centered amber message: `"{N} item(s) need assignment before splitting"` -- do NOT disable the Split tab (per research recommendation).
- **Bill total header**: `"Bill total"` label + `$XX.XX` amount. Compute as `result.results.reduce((s, r) => s + r.roundedTotalCents, 0)`. Show the rounded total only (no rounding annotation -- per user decision, footer handles that).
- **Person cards**: Map `result.results` to `<PersonCard>` components. Look up person via `config.people.find(p => p.id === r.personId)`. Person ordering: insertion order (order added -- per discretion recommendation).
- **Rounding footer**: Render `<RoundingFooter>` only when `result.totalSurplusCents > 0` (hidden when zero per user decision).
- **Copy all button**: Fixed at the bottom of the panel (sticky within the scroll area or as a bottom bar). Full-width button: `"Copy summary"` text, `bg-blue-600 text-white font-medium rounded-xl min-h-12 active:bg-blue-700`. On click, build text with `formatSummary(result, config.people)` and call `copy(text, 'Summary copied!')` from `useCopyToClipboard`.
- **Individual person copy**: Pass a `handlePersonCopy` callback to PersonCard that calls `formatPersonSummary()` + `copy()`.
- **Toast**: Render `<Toast>` from `useCopyToClipboard`'s `showToast`/`toastMessage` state. Position it as a sibling outside the scrollable area so it floats above content.
- Layout: flex column, bill total header at top with bottom border, scrollable card list in the middle (`flex-1 overflow-y-auto`), copy-all button fixed at bottom with top border.
  </action>
  <verify>
Run `npx vitest run` -- all existing tests pass (no regressions). Run `npx vite build` -- zero TypeScript errors. Verify files exist: `ls src/components/summary/` shows all 5 component files, `ls src/utils/formatSummary.ts`, `ls src/hooks/useCopyToClipboard.ts`.
  </verify>
  <done>
Seven files created: formatSummary utility, useCopyToClipboard hook, Toast, CopyButton, RoundingFooter, PersonCard, and SummaryPanel. SummaryPanel reads getResult() once, renders bill total, person cards with expand/collapse detail, rounding footer (hidden when zero), and copy-all button. Individual copy icons on each card. Toast notification for copy feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SummaryPanel into AppShell and write tests</name>
  <files>
    src/components/layout/AppShell.tsx
    src/utils/formatSummary.test.ts
    src/components/summary/SummaryPanel.test.tsx
  </files>
  <action>
**AppShell.tsx** -- Add SummaryPanel below TipTaxPanel in the split tab:
- Import `SummaryPanel` from `'../summary/SummaryPanel'`
- Update the split tab panel div to render both TipTaxPanel and SummaryPanel vertically:
  ```tsx
  <div className={activeTab === 'split' ? '' : 'hidden'}>
    <TipTaxPanel />
    <SummaryPanel />
  </div>
  ```
- TipTaxPanel renders first (user configures tip/tax), SummaryPanel renders below (user sees results). Both are in the same scrollable area.

**src/utils/formatSummary.test.ts** -- Unit tests for the utility:
- Import `formatSummary`, `formatPersonSummary` from `./formatSummary`
- Import types and constructors: `cents`, `personId` from engine/types
- Test cases:
  1. "formatSummary produces labeled breakdown format" -- Create a mock EngineSuccess with 2 people, verify output matches `"Bill Split:\n- Alice owes $23.50\n- Bob owes $18.00\nTotal: $41.50 (includes tip + tax)"` pattern
  2. "formatSummary handles single person" -- One person, verify correct format
  3. "formatPersonSummary produces individual line" -- Verify `"Alice owes $23.50"` format
  4. "formatSummary uses roundedTotalCents (not exactTotalCents)" -- Create result where rounded differs from exact, verify rounded value appears
- These are pure function tests -- no jsdom needed, no vitest-environment directive

**src/components/summary/SummaryPanel.test.tsx** -- Component tests:
- Add `// @vitest-environment jsdom` at top
- `useBillStore.getState().reset()` in beforeEach
- Helper: set up a valid bill (2 people, 2 items, all assigned, tip 18%, tax $5)
- Test cases:
  1. "renders bill total at the top" -- verify dollar amount text visible
  2. "renders a card for each person" -- verify both person names visible
  3. "person card shows rounded total" -- verify dollar amounts displayed
  4. "tapping card expands to show food, tip, tax detail" -- click card, verify "Food", "Tip", "Tax" labels appear
  5. "rounding footer hidden when surplus is zero" -- set up bill where rounding surplus = 0, verify no "rounding surplus" text
  6. "rounding footer visible when surplus > 0" -- set up bill where rounding occurs, verify surplus text appears
  7. "shows error state when items are unassigned" -- add items without assignment, verify "need assignment" message
  8. "copy all button renders" -- verify "Copy summary" button exists
- Use `@testing-library/react` render, screen, fireEvent/userEvent
- Use `waitFor` if needed for async state updates
  </action>
  <verify>
Run `npx vitest run` -- all tests pass (existing ~111 from plan 01 + ~4 formatSummary + ~8 SummaryPanel = ~123 total). Run `npx vite build` -- zero errors. Verify AppShell imports SummaryPanel: `grep "SummaryPanel" src/components/layout/AppShell.tsx`.
  </verify>
  <done>
SummaryPanel wired into AppShell's split tab below TipTaxPanel. 4 unit tests for formatSummary verify the clipboard text format. 8 component tests for SummaryPanel verify bill total display, person cards, expand/collapse detail, rounding footer visibility, error state for unassigned items, and copy button presence. All tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Split tab flow on mobile viewport</name>
  <files>none</files>
  <action>
Human verification checkpoint. What was built: Complete Phase 3 Output -- Tip/Tax configuration panel and per-person summary with copy-to-clipboard, all inside a new "Split" tab. The full bill-splitting flow is now end-to-end functional.
  </action>
  <how-to-verify>
1. Run `npx vite` to start the dev server
2. Open in browser at the provided localhost URL
3. Use Chrome DevTools mobile viewport (e.g., iPhone 14 Pro, 393x852)

**Data setup (People + Items + Assign tabs):**
4. Go to People tab -- add "Alice" and "Bob"
5. Go to Items tab -- add "Burger" ($15.00), "Salad" ($12.00), "Fries" ($8.00)
6. Go to Assign tab -- assign Burger to Alice only, Salad to Bob only, Fries to Everyone

**Tip/Tax configuration (Split tab - top section):**
7. Tap the "Split" tab -- should see Tip and Tax sections
8. Tap 18% -- segment highlights blue, stays selected
9. Tap 20% -- segment changes to 20%
10. Tap "Custom" -- an input field appears below the presets
11. Type "22" in the custom field, tap away -- custom tip set
12. Tap 15% -- input field hides, 15% selected
13. Under Tip, verify Equal/Proportional toggle -- tap Proportional, then back to Equal
14. Under Tax, tap the "%" button, type "8.5", tap away
15. Tap the "$" button -- input clears, switch to dollar mode
16. Type "3.50", tap away -- tax set to $3.50
17. Under Tax, verify separate Equal/Proportional toggle works independently

**Summary display (Split tab - bottom section):**
18. Scroll down to see the summary section
19. Verify "Bill total: $XX.XX" at the top -- should be sum of all person totals
20. Verify Alice's card shows her name and total (Burger $15 + half of Fries $4 = $19 food + her tip + tax share)
21. Verify Bob's card shows his name and total (Salad $12 + half of Fries $4 = $16 food + his tip + tax share)
22. Tap Alice's card -- should expand with smooth animation showing Food, Tip, Tax breakdown
23. Tap again -- should collapse
24. If rounding surplus > $0.00 -- verify footer text appears below cards (e.g., "+$0.02 rounding surplus")
25. If surplus is exactly $0.00 -- verify NO footer appears

**Copy functionality:**
26. Tap the small copy icon on Alice's card -- toast appears briefly ("Copied!")
27. Paste somewhere -- should see "Alice owes $XX.XX"
28. Tap "Copy summary" button at the bottom -- toast appears ("Summary copied!")
29. Paste somewhere -- should see labeled format:
    ```
    Bill Split:
    - Alice owes $XX.XX
    - Bob owes $XX.XX
    Total: $XX.XX (includes tip + tax)
    ```

**Edge cases:**
30. Go back to Items tab, add a new item but do NOT assign it
31. Go to Split tab -- summary should show error message about unassigned items
32. Go to Assign tab, assign the new item to Alice
33. Go back to Split tab -- summary should now show all three people's totals correctly

**Tip recalculation:**
34. On Split tab, select 18% tip
35. Go to Items tab, add "Dessert" ($10.00)
36. Go to Assign tab, assign Dessert to Alice
37. Go back to Split tab -- tip amount should have auto-recalculated based on new subtotal
  </how-to-verify>
  <resume-signal>Type "approved" if the full Split tab works correctly, or describe any issues found</resume-signal>
  <verify>Human visually confirms all verification steps above pass on mobile viewport</verify>
  <done>Full Split tab flow verified: tip presets, custom tip, tax dollar/percent, split method toggles, per-person summary cards with expand/collapse, rounding footer, copy-all and individual copy with toast, error state for unassigned items, tip recalculation on subtotal change</done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass (~123+ total)
2. `npx vite build` -- zero TypeScript errors, clean production build
3. Full Split tab functional: tip presets + custom, tax dollar/percent, split method toggles, per-person summary cards with expand/collapse, rounding footer when applicable, copy-all and individual copy with toast
4. Error state for unassigned items is friendly and informative
5. Tip auto-recalculates when subtotal changes
</verification>

<success_criteria>
- Bill total displayed at top of summary for receipt comparison
- Per-person cards show name and rounded total, stacked vertically and scrollable
- Tapping a card expands to show food subtotal, tip share, tax share with smooth animation
- Rounding surplus footer appears only when surplus > $0.00
- "Copy summary" button copies labeled breakdown format to clipboard
- Individual copy icon on each card copies that person's amount
- Toast notification appears on copy (brief, non-obstructive, at bottom of screen)
- Unassigned items show friendly error state (not a disabled tab)
- All existing and new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-output/03-02-SUMMARY.md`
</output>
