---
phase: 01-foundation
plan: 02
type: tdd
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/engine/engine.ts
  - src/engine/engine.test.ts
autonomous: true
requirements:
  - ASGN-02
  - TPTX-02
  - TPTX-04
  - SUMM-02

must_haves:
  truths:
    - "Shared items are split equally among only their assigned sharers, with fractional cents distributed via largest-remainder"
    - "Tip can be split equal (among eligible people) or proportional to each person's food subtotal"
    - "Tax can be split equal (among eligible people) or proportional to each person's food subtotal"
    - "Each person's final total is rounded up to the nearest cent and surplus is computed"
    - "Unassigned items cause the engine to return an error result, not a partial calculation"
    - "Person with no food items and includeZeroFoodPeople=false gets zero tip/tax"
    - "Person with no food items and includeZeroFoodPeople=true gets their share of tip/tax"
    - "All Vitest tests pass for party sizes 1-10 across equal and proportional split methods"
  artifacts:
    - path: "src/engine/engine.ts"
      provides: "Pure calculation functions: computeSplit, distributeIntegerCents, distributeItems, distributeCharge"
      exports: ["computeSplit", "distributeIntegerCents"]
      min_lines: 80
    - path: "src/engine/engine.test.ts"
      provides: "Comprehensive Vitest test suite: shared items, proportional splits, rounding, edge cases"
      min_lines: 150
  key_links:
    - from: "src/engine/engine.ts"
      to: "src/engine/types.ts"
      via: "type imports"
      pattern: "import.*from.*types"
    - from: "src/engine/engine.test.ts"
      to: "src/engine/engine.ts"
      via: "function imports"
      pattern: "import.*(computeSplit|distributeIntegerCents).*from.*engine"
---

<objective>
Build the pure calculation engine using TDD — write failing tests first, then implement the engine functions to make them pass. The engine is the mathematical core of the application: it takes a BillConfig and produces per-person breakdowns with fair distribution of shared items, tip, and tax.

Purpose: This is the highest-risk code in the project. Floating-point errors, rounding bugs, and unfair distributions are the top pitfalls identified in research. TDD ensures correctness is proven before moving on. The engine is pure functions with zero dependencies on React or Zustand, making tests fast and deterministic.

Output: `src/engine/engine.ts` (pure functions) and `src/engine/engine.test.ts` (comprehensive test suite), all tests green.
</objective>

<execution_context>
@/Users/shantnupatil/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantnupatil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@src/engine/types.ts
</context>

<feature>
  <name>Bill-splitting calculation engine</name>
  <files>src/engine/engine.ts, src/engine/engine.test.ts</files>
  <behavior>
    The engine exposes one primary function: `computeSplit(config: BillConfig): EngineResult`.

    **Core behaviors to test (RED phase — write these tests FIRST):**

    1. **distributeIntegerCents (helper function):**
       - 10 cents / 3 people => [4, 3, 3] (sum = 10, largest-remainder)
       - 100 cents / 3 people => [34, 33, 33] (sum = 100)
       - 7 cents / 2 people => [4, 3] (sum = 7)
       - 0 cents / 3 people => [0, 0, 0]
       - 1 cent / 5 people => [1, 0, 0, 0, 0] (one person gets it)
       - 100 cents / 1 person => [100]
       - Sum of distributed cents ALWAYS equals the input total (invariant test)

    2. **Shared item distribution (ASGN-02):**
       - Item $10.00 (1000 cents) shared by persons A, B, C: A gets 334, B gets 333, C gets 333 (largest-remainder)
       - Item $5.00 (500 cents) assigned to person A only: A gets 500
       - Two items: $10 shared by A+B, $7 individual to C: A gets 500, B gets 500, C gets 700
       - Item with quantity 2, price $5.00: total = 1000 cents, distributed among sharers

    3. **Tip split — equal (TPTX-02):**
       - 3 people, tip 300 cents, equal: each gets 100
       - 3 people, tip 100 cents, equal: [34, 33, 33] via largest-remainder
       - Person with no food, includeZeroFoodPeople=true: included in equal split
       - Person with no food, includeZeroFoodPeople=false: excluded, gets 0 tip

    4. **Tip split — proportional (TPTX-02):**
       - A has $20 food, B has $10 food, tip $9: A gets $6 tip, B gets $3 tip
       - A has $10 food, B has $0 food (includeZeroFoodPeople=true): B gets 0 proportional tip (weight is 0), A gets all tip
       - Proportional with remainders uses largest-remainder for fair distribution

    5. **Tax split — equal and proportional (TPTX-04):**
       - Same patterns as tip but using the tax config
       - Tax equal and tip proportional in same config (mixed methods)

    6. **Rounding up to nearest cent (SUMM-02):**
       - Each person's roundedTotalCents >= exactTotalCents
       - surplusCents = roundedTotalCents - exactTotalCents (per person)
       - totalSurplusCents = sum of all person surpluses
       - When all distributions use largest-remainder, exactTotalCents is already integer, so surplus is 0 (this is correct and expected)

    7. **Unassigned items block calculation:**
       - Config with one item having no assignments: returns { ok: false, reason: 'unassigned_items', unassignedItemIds: [itemId] }
       - Config with item assigned to empty array []: also returns error

    8. **Party size scaling (1-10 people):**
       - Use test.each with party sizes 1-10
       - For each: sum of all person food cents = sum of all item costs
       - For each: sum of all person tip cents = total tip
       - For each: sum of all person tax cents = total tax

    9. **Edge cases:**
       - Zero tip, zero tax: each person's total = food only
       - All items shared by everyone: equivalent to even split
       - One person, one item: that person gets everything
       - Person removed (not in assignments): excluded from results
  </behavior>
  <implementation>
    After tests are written and FAIL (RED), implement:

    **`distributeIntegerCents(totalCents: number, count: number): number[]`**
    - Floor division, compute remainders, sort by largest fractional part, distribute extra cents
    - Edge case: count = 0 returns [], count = 1 returns [totalCents]

    **`distributeItems(items: Item[], assignments: Assignments, people: Person[]): Record<PersonId, number>`**
    - For each item: compute total cost = priceCents * quantity
    - Get assigned people for that item
    - Use distributeIntegerCents to split cost among assigned people
    - Accumulate each person's food total

    **`distributeCharge(chargeCents: number, method: SplitMethod, includeZeroFood: boolean, people: Person[], foodMap: Record<PersonId, number>): Record<PersonId, number>`**
    - If method = 'equal': find eligible people (those with food > 0, OR those with includeZeroFood = true). Distribute equally via distributeIntegerCents.
    - If method = 'proportional': use each person's food total as weight. People with 0 food get 0 (regardless of includeZeroFood — proportional share of 0 is 0). Distribute via largest-remainder proportional function.

    **`computeSplit(config: BillConfig): EngineResult`**
    1. Validate: any item with missing or empty assignment => return error
    2. distributeItems => foodMap
    3. distributeCharge for tip => tipMap
    4. distributeCharge for tax => taxMap
    5. For each person: sum food + tip + tax = exactTotalCents, Math.ceil = roundedTotalCents, surplus = rounded - exact
    6. Return { ok: true, results, totalSurplusCents }

    **TDD commits:**
    - RED: `test(01-02): add failing tests for bill-splitting engine`
    - GREEN: `feat(01-02): implement calculation engine — all tests pass`
    - REFACTOR (if needed): `refactor(01-02): clean up engine implementation`
  </implementation>
</feature>

<verification>
1. `npx vitest run src/engine/engine.test.ts` — ALL tests pass
2. No test is skipped or pending
3. `npx tsc --noEmit` — zero type errors
4. Test count: minimum 20 test cases covering all behaviors listed above
5. Invariant checks in tests: sum of distributed amounts always equals input total
</verification>

<success_criteria>
- `src/engine/engine.ts` exports `computeSplit` and `distributeIntegerCents` as pure functions
- `src/engine/engine.test.ts` has 20+ test cases covering shared items, equal/proportional tip, equal/proportional tax, rounding, unassigned items, party sizes 1-10, and edge cases
- All tests pass with `npx vitest run`
- Zero type errors
- Engine never uses floating-point dollars internally — all arithmetic on integer cents
- Engine returns both exact and rounded totals with surplus
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
