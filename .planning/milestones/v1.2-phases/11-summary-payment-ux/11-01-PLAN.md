---
phase: 11-summary-payment-ux
plan: 01
title: "Payer store, settlement direction, and UPI navigation"
requirements: [SUM-01, SUM-02, SUM-04]
depends_on: []
estimated_tasks: 3

must_haves:
  - "billStore has payerId field (PersonId | null) with setPayerId action"
  - "payerId is included in billStore persist partialize (persists across refresh)"
  - "PaymentSection reads payerId from billStore instead of local useState"
  - "PaymentSection accepts onTabChange prop and passes it to 'No UPI ID' tap handler"
  - "Tapping 'No UPI ID' text navigates to the People tab"
  - "PersonCard accepts optional payerName prop"
  - "When payerName is provided, non-payer cards show 'owes [payerName]' subtitle below total"
  - "Payer's own PersonCard shows 'Paid' subtitle instead of 'owes'"
  - "SummaryPanel passes payerName and onTabChange props through to children"
  - "User selects payer, switches tabs, switches back — payer still selected"
  - "All existing 144 tests still pass"

key_links:
  - from: "src/store/billStore.ts"
    to: "src/components/summary/PaymentSection.tsx"
    via: "payerId state + setPayerId action replaces local useState"
  - from: "src/components/summary/SummaryPanel.tsx"
    to: "src/components/summary/PersonCard.tsx"
    via: "payerName prop passed from SummaryPanel to PersonCard"
  - from: "src/components/summary/PaymentSection.tsx"
    to: "src/components/layout/AppShell.tsx"
    via: "onTabChange callback prop for 'No UPI ID' navigation"
---

# Plan 11-01: Payer Store, Settlement Direction, and UPI Navigation

## Goal

Move payer selection to the Zustand store so it persists across tab switches and page refreshes. Show "owes [payer name]" on each person card when a payer is selected. Make "No UPI ID" tappable to navigate to the People tab.

## Context

- `PaymentSection` currently holds `payerId` as local `useState<PersonId | ''>('')` (line 20)
- `billStore` already has persist middleware (version 2, `bill-splitter-active` key)
- `PersonCard` currently shows name + amount + food/tip/tax breakdown — no settlement direction
- "No UPI ID" is a plain `<span>` at PaymentSection line 97
- `SummaryPanel` renders `PersonCard` in a loop and `PaymentSection` at the bottom
- `SummaryPanel` doesn't currently receive `onTabChange` — it needs to be threaded from `AppShell`

## Tasks

### Task 1: Add payerId to billStore

**Do:**
1. Edit `src/store/billStore.ts`:
   - Add `payerId: PersonId | null` to `BillState` interface (after `currentSplitId`)
   - Add `setPayerId: (id: PersonId | null) => void` to actions in interface
   - Initialize `payerId: null` in `stateCreator`
   - Add `setPayerId` implementation:
     ```typescript
     setPayerId(id: PersonId | null) {
       set((state) => {
         state.payerId = id;
       });
     },
     ```
   - Update `partialize` to include payerId:
     ```typescript
     partialize: (state) => ({ config: state.config, payerId: state.payerId }),
     ```
   - Update `merge` to restore payerId:
     ```typescript
     const p = persisted as { config?: unknown; payerId?: unknown } | undefined;
     if (p?.config) {
       return {
         ...currentState,
         config: deserializeBillConfig(p.config),
         payerId: (p.payerId as PersonId) ?? null,
       };
     }
     ```
   - Update `reset()` to clear payerId: add `state.payerId = null;`

**Verify:**
- `npx tsc --noEmit` passes
- `npx vitest run` — all 144 tests pass (payerId defaults to null, no behavior change)

### Task 2: Update PaymentSection and add UPI navigation

**Do:**
1. Edit `src/components/summary/PaymentSection.tsx`:
   - Remove `import { useState } from 'react';`
   - Add import: `import { useBillStore } from '../../store/billStore';`
   - Add import: `import type { Tab } from '../layout/TabBar';`
   - Add `onTabChange` prop to interface:
     ```typescript
     interface PaymentSectionProps {
       people: Person[];
       results: PersonResult[];
       onTabChange: (tab: Tab) => void;
     }
     ```
   - Replace local useState with store:
     ```typescript
     // Replace: const [payerId, setPayerId] = useState<PersonId | ''>('');
     const payerId = useBillStore((s) => s.payerId);
     const setPayerId = useBillStore((s) => s.setPayerId);
     ```
   - Update the select onChange to handle the '' → null conversion:
     ```typescript
     onChange={(e) => setPayerId(e.target.value ? (e.target.value as PersonId) : null)}
     ```
   - Update the select value to handle null → '' conversion:
     ```typescript
     value={payerId ?? ''}
     ```
   - Update the payer lookup to use null instead of '':
     ```typescript
     const payer = people.find((p) => p.id === payerId) ?? null;
     ```
   - Update debtors filter to use payerId (already works with null since no person has null id)
   - Replace "No UPI ID" span (line 97) with a tappable button:
     ```tsx
     <button
       onClick={() => onTabChange('people')}
       className="ml-3 text-blue-400 text-xs shrink-0 underline"
     >
       Add UPI ID
     </button>
     ```

2. Edit `src/components/summary/SummaryPanel.tsx`:
   - Add `onTabChange` to props — but SummaryPanel currently has no props. We need to thread it from AppShell.
   - Add import: `import type { Tab } from '../layout/TabBar';`
   - Add interface and prop:
     ```typescript
     interface SummaryPanelProps {
       onTabChange: (tab: Tab) => void;
     }
     export function SummaryPanel({ onTabChange }: SummaryPanelProps) {
     ```
   - Pass `onTabChange` to PaymentSection:
     ```tsx
     <PaymentSection people={people} results={successResult.results} onTabChange={onTabChange} />
     ```

3. Edit `src/components/layout/AppShell.tsx`:
   - Pass `onTabChange` to SummaryPanel:
     ```tsx
     <SummaryPanel onTabChange={setActiveTab} />
     ```

4. Edit `src/components/summary/SummaryPanel.test.tsx`:
   - Add `const mockOnTabChange = vi.fn();` near the top of the test file
   - Update ALL `render(<SummaryPanel />)` calls to `render(<SummaryPanel onTabChange={mockOnTabChange} />)`
   - There are 8 render calls that need updating (follow the same pattern as `AssignmentPanel.test.tsx`)

**Verify:**
- `npx tsc --noEmit` passes
- `npx vitest run` — all 144 tests pass

### Task 3: Add settlement direction to PersonCard

**Do:**
1. Edit `src/components/summary/PersonCard.tsx`:
   - Add optional props to interface:
     ```typescript
     interface PersonCardProps {
       person: Person;
       result: PersonResult;
       onCopy: (personId: PersonId) => void;
       payerName?: string;
       isPayer?: boolean;
     }
     ```
   - Destructure new props:
     ```typescript
     export function PersonCard({ person, result, onCopy, payerName, isPayer }: PersonCardProps) {
     ```
   - Add settlement subtitle below the person name in the header (line 52 area):
     ```tsx
     <div className="flex flex-col">
       <span className="text-gray-100 font-medium">{person.name}</span>
       {payerName && (
         <span className="text-xs text-gray-400">
           {isPayer ? 'Paid' : `owes ${payerName}`}
         </span>
       )}
     </div>
     ```

2. Edit `src/components/summary/SummaryPanel.tsx`:
   - Read payerId from store:
     ```typescript
     // Add payerId to the useBillStore selector
     const { getResult, people, tipCents, taxCents, config, currentSplitId, setCurrentSplitId, payerId } = useBillStore(
       useShallow((s) => ({
         ...existing fields...,
         payerId: s.payerId,
       }))
     );
     ```
   - Compute payerName:
     ```typescript
     const payerName = payerId ? people.find((p) => p.id === payerId)?.name : undefined;
     ```
   - Pass to PersonCard:
     ```tsx
     <PersonCard
       key={personResult.personId}
       person={person}
       result={personResult}
       onCopy={handlePersonCopy}
       payerName={payerName}
       isPayer={person.id === payerId}
     />
     ```

**Verify:**
- `npx tsc --noEmit` passes
- `npx vitest run` — all tests pass
- `npm run build` succeeds

## Acceptance

After this plan:
- Selecting a payer in the dropdown persists across tab switches AND page refresh
- Each person card shows "owes [payer name]" subtitle; payer's card shows "Paid"
- Tapping "Add UPI ID" (was "No UPI ID") navigates to the People tab
- All 144 tests pass, TypeScript clean, build succeeds
